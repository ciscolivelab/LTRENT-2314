{"config":{"indexing":"full","lang":["en"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"LTRENT-2314 Welcome to Cisco Live LTRENT-2314: Advanced SD-WAN Lab Preface This document describes the Cisco SD-WAN Advanced Lab. Audience This document is intended for use by attendees of the Cisco Live 2023 who are taking the SD-WAN Advanced Lab (LTRENT-2314). Speakers Azharuddin Mohammed Customer Delivery Architect Lei Tian Customer Delivery Architect","title":"Home"},{"location":"#ltrent-2314","text":"Welcome to Cisco Live LTRENT-2314: Advanced SD-WAN Lab","title":"LTRENT-2314"},{"location":"#preface","text":"This document describes the Cisco SD-WAN Advanced Lab.","title":"Preface"},{"location":"#audience","text":"This document is intended for use by attendees of the Cisco Live 2023 who are taking the SD-WAN Advanced Lab (LTRENT-2314).","title":"Audience"},{"location":"#speakers","text":"Azharuddin Mohammed Customer Delivery Architect Lei Tian Customer Delivery Architect","title":"Speakers"},{"location":"access/","text":"About this lab In this lab, you will be introduced with advanced SD-WAN topics including advanced routing, central control policy, QoS, per-tunnel QoS, Direct Internet Access, Cloud OnRamp for SaaS, Dynamic tunneling. The lab will be built with Network Function Virtualization for Viptela and IOS XE SD-WAN image. Lab Flow In this lab, you will follow the lab guide to configure: Advanced Routing Migration Performance & Optimization Lab Access Below table provides the IP addresses and credentials for the devices used in this lab: Note: You are able to access all devices via SSH and GUI after AnyConnect into dCloud. There is no remote desktop or any jump server required to access the lab. If you don't have AnyConnect VPN Client installed, you can download AnyConnect from here https://developer.cisco.com/site/devnet/sandbox/anyconnect/ Device IP Username Password vManage GUI 198.18.133.200:8443 admin pocadmin vManage SSH 198.18.133.200:19001 admin pocadmin vbond 198.18.133.200:19002 admin admin vSmart 198.18.133.200:19003 admin admin DC1-WE1 198.18.133.200:19010 admin admin DC1-WE2 198.18.133.200:19009 admin admin DC2-WE1 198.18.133.200:19014 admin admin DC2-WE2 198.18.133.200:19012 admin admin RH-WE1 198.18.133.200:19016 admin admin R1-WE1 198.18.133.200:19017 admin admin R2-WE1 198.18.133.200:19020 admin admin R1-VM1 198.18.133.200:19018 viptela viptela R2-VM1 198.18.133.200:19019 viptela viptela You can also login the remote host via VNC . If you don't have VNC client installed, you can download VNCviewer from here https://www.realvnc.com/en/connect/download/viewer/ Device IP Username Password R1-VM1 198.18.133.200:30500 viptela viptela R2-VM1 198.18.133.200:30501 viptela viptela Lab Topology","title":"Lab Access"},{"location":"access/#about-this-lab","text":"In this lab, you will be introduced with advanced SD-WAN topics including advanced routing, central control policy, QoS, per-tunnel QoS, Direct Internet Access, Cloud OnRamp for SaaS, Dynamic tunneling. The lab will be built with Network Function Virtualization for Viptela and IOS XE SD-WAN image.","title":"About this lab"},{"location":"access/#lab-flow","text":"In this lab, you will follow the lab guide to configure: Advanced Routing Migration Performance & Optimization","title":"Lab Flow"},{"location":"access/#lab-access","text":"Below table provides the IP addresses and credentials for the devices used in this lab: Note: You are able to access all devices via SSH and GUI after AnyConnect into dCloud. There is no remote desktop or any jump server required to access the lab. If you don't have AnyConnect VPN Client installed, you can download AnyConnect from here https://developer.cisco.com/site/devnet/sandbox/anyconnect/ Device IP Username Password vManage GUI 198.18.133.200:8443 admin pocadmin vManage SSH 198.18.133.200:19001 admin pocadmin vbond 198.18.133.200:19002 admin admin vSmart 198.18.133.200:19003 admin admin DC1-WE1 198.18.133.200:19010 admin admin DC1-WE2 198.18.133.200:19009 admin admin DC2-WE1 198.18.133.200:19014 admin admin DC2-WE2 198.18.133.200:19012 admin admin RH-WE1 198.18.133.200:19016 admin admin R1-WE1 198.18.133.200:19017 admin admin R2-WE1 198.18.133.200:19020 admin admin R1-VM1 198.18.133.200:19018 viptela viptela R2-VM1 198.18.133.200:19019 viptela viptela You can also login the remote host via VNC . If you don't have VNC client installed, you can download VNCviewer from here https://www.realvnc.com/en/connect/download/viewer/ Device IP Username Password R1-VM1 198.18.133.200:30500 viptela viptela R2-VM1 198.18.133.200:30501 viptela viptela","title":"Lab Access"},{"location":"access/#lab-topology","text":"","title":"Lab Topology"},{"location":"intro/","text":"Lab Introduction Company ACME is a multi-international company where it has branches world wide which include two Data Centers in San Jose and RTP and few regional hubs in different continents as well as remote branches world wide. Lab Design This lab is designed to help you understand various advanced routing features based upon a large multi-international company design. The lab is based on dcloud and simulating ACME's topology with 5 Wan Edges(wEdges). All the basic connectivity as well as feature templates, devices templates and some lists have been pre-configured for you. You should be able to go straight to those LAB tasks. As shown in the above diagram: DC1 has two cEdges which connects to three transports DC2 has also two cEdges which connect to three transports as well RH(reginal hub) has one cEdge Both DC1-WEs and DC2-WEs are running eBGP with DC routers, BGP has been preconfigured for you. Remote1 has one cEdge connecting to private1 and LTE Remote2 has one cEdge connecting to private2 and LTE Lab Access Please find your anyconnect login from your proctor. Connect to anyconnect VPN dcloud-rtp-anyconnect.cisco.com with the provided username and password. After prompted for credentials, use the credentials provided by lab proctor . Hit accept when the prompt appears to accept the VPN connection login","title":"Lab Introduction"},{"location":"intro/#lab-introduction","text":"Company ACME is a multi-international company where it has branches world wide which include two Data Centers in San Jose and RTP and few regional hubs in different continents as well as remote branches world wide.","title":"Lab Introduction"},{"location":"intro/#lab-design","text":"This lab is designed to help you understand various advanced routing features based upon a large multi-international company design. The lab is based on dcloud and simulating ACME's topology with 5 Wan Edges(wEdges). All the basic connectivity as well as feature templates, devices templates and some lists have been pre-configured for you. You should be able to go straight to those LAB tasks. As shown in the above diagram: DC1 has two cEdges which connects to three transports DC2 has also two cEdges which connect to three transports as well RH(reginal hub) has one cEdge Both DC1-WEs and DC2-WEs are running eBGP with DC routers, BGP has been preconfigured for you. Remote1 has one cEdge connecting to private1 and LTE Remote2 has one cEdge connecting to private2 and LTE","title":"Lab Design"},{"location":"intro/#lab-access","text":"Please find your anyconnect login from your proctor. Connect to anyconnect VPN dcloud-rtp-anyconnect.cisco.com with the provided username and password. After prompted for credentials, use the credentials provided by lab proctor . Hit accept when the prompt appears to accept the VPN connection login","title":"Lab Access"},{"location":"intro2/","text":"Lab Introduction Company ACME is a multi-international company where it has branches world wide which include two Data Centers in San Jose and RTP and few regional hubs in different continents as well as remote branches world wide. Lab Design This lab is designed to help you understand various advanced routing features based upon a large multi-international company design. The lab is based on dcloud and simulating ACME's topology with 5 Wan Edges(wEdges). All the basic connectivity as well as feature templates, devices templates and some lists have been pre-configured for you. You should be able to go straight to those LAB tasks. As shown in the above diagram: DC1 has two cEdges which connects to three transports DC2 has also two cEdges which connect to three transports as well RH(reginal hub) has one cEdge Both DC1-WEs and DC2-WEs are running eBGP with DC routers, BGP has been preconfigured for you. Remote1 has one cEdge connecting to private1 and LTE Remote2 has one cEdge connecting to private2 and LTE Lab Access You will connect to 'Anyconnect url' using Cisco VPN AnyConnect client and with the username & password as documented in below table. Pod ID Attendee Name Anyconnect url Anyconnect Username Anyconnect Password POD 1 dcloud-lon-anyconnect.cisco.com POD 2 dcloud-lon-anyconnect.cisco.com POD 3 dcloud-lon-anyconnect.cisco.com POD 4 dcloud-lon-anyconnect.cisco.com POD 5 dcloud-lon-anyconnect.cisco.com POD 6 dcloud-lon-anyconnect.cisco.com POD 7 dcloud-lon-anyconnect.cisco.com POD 8 dcloud-lon-anyconnect.cisco.com POD 9 dcloud-lon-anyconnect.cisco.com POD 10 dcloud-lon-anyconnect.cisco.com POD 11 dcloud-lon-anyconnect.cisco.com POD 12 dcloud-lon-anyconnect.cisco.com POD 13 dcloud-lon-anyconnect.cisco.com POD 14 dcloud-lon-anyconnect.cisco.com POD 15 dcloud-lon-anyconnect.cisco.com POD 16 dcloud-lon-anyconnect.cisco.com POD 17 dcloud-lon-anyconnect.cisco.com POD 18 dcloud-lon-anyconnect.cisco.com Connect to anyconnect VPN dcloud-rtp-anyconnect.cisco.com with the provided username and password. After prompted for credentials, use the credentials provided by lab proctor . Hit accept when the prompt appears to accept the VPN connection login Lab Access without AnyConnect VPN If you do not have AnyConnect and your CCO ID is not entitled for downloading AnyConnect VPN client software. You can still finish majority of tasks in this lab over a public routable IP of your vManage. However, you will not able to run tasks that require access to Ubuntu host. Accessing this lab over public routable IP should only be considered if you do not have AnyConnect VPN. If you use vManage public IP to access the lab , you can use your vManage's public IP to replace \"198.18.133.200\" through out the labguide. Also use vManage SSH Terminal where you need to SSH WAN Edge through out the labguide. Please find your vManage public routable IP from your proctor.","title":"Getting Started"},{"location":"intro2/#lab-introduction","text":"Company ACME is a multi-international company where it has branches world wide which include two Data Centers in San Jose and RTP and few regional hubs in different continents as well as remote branches world wide.","title":"Lab Introduction"},{"location":"intro2/#lab-design","text":"This lab is designed to help you understand various advanced routing features based upon a large multi-international company design. The lab is based on dcloud and simulating ACME's topology with 5 Wan Edges(wEdges). All the basic connectivity as well as feature templates, devices templates and some lists have been pre-configured for you. You should be able to go straight to those LAB tasks. As shown in the above diagram: DC1 has two cEdges which connects to three transports DC2 has also two cEdges which connect to three transports as well RH(reginal hub) has one cEdge Both DC1-WEs and DC2-WEs are running eBGP with DC routers, BGP has been preconfigured for you. Remote1 has one cEdge connecting to private1 and LTE Remote2 has one cEdge connecting to private2 and LTE","title":"Lab Design"},{"location":"intro2/#lab-access","text":"You will connect to 'Anyconnect url' using Cisco VPN AnyConnect client and with the username & password as documented in below table. Pod ID Attendee Name Anyconnect url Anyconnect Username Anyconnect Password POD 1 dcloud-lon-anyconnect.cisco.com POD 2 dcloud-lon-anyconnect.cisco.com POD 3 dcloud-lon-anyconnect.cisco.com POD 4 dcloud-lon-anyconnect.cisco.com POD 5 dcloud-lon-anyconnect.cisco.com POD 6 dcloud-lon-anyconnect.cisco.com POD 7 dcloud-lon-anyconnect.cisco.com POD 8 dcloud-lon-anyconnect.cisco.com POD 9 dcloud-lon-anyconnect.cisco.com POD 10 dcloud-lon-anyconnect.cisco.com POD 11 dcloud-lon-anyconnect.cisco.com POD 12 dcloud-lon-anyconnect.cisco.com POD 13 dcloud-lon-anyconnect.cisco.com POD 14 dcloud-lon-anyconnect.cisco.com POD 15 dcloud-lon-anyconnect.cisco.com POD 16 dcloud-lon-anyconnect.cisco.com POD 17 dcloud-lon-anyconnect.cisco.com POD 18 dcloud-lon-anyconnect.cisco.com Connect to anyconnect VPN dcloud-rtp-anyconnect.cisco.com with the provided username and password. After prompted for credentials, use the credentials provided by lab proctor . Hit accept when the prompt appears to accept the VPN connection login","title":"Lab Access"},{"location":"intro2/#lab-access-without-anyconnect-vpn","text":"If you do not have AnyConnect and your CCO ID is not entitled for downloading AnyConnect VPN client software. You can still finish majority of tasks in this lab over a public routable IP of your vManage. However, you will not able to run tasks that require access to Ubuntu host. Accessing this lab over public routable IP should only be considered if you do not have AnyConnect VPN. If you use vManage public IP to access the lab , you can use your vManage's public IP to replace \"198.18.133.200\" through out the labguide. Also use vManage SSH Terminal where you need to SSH WAN Edge through out the labguide. Please find your vManage public routable IP from your proctor.","title":"Lab Access without AnyConnect VPN"},{"location":"lab1/","text":"Lab 1: Advanced Routing In this section, you will help ACME on an advanced routing using both local and central policy. You will perform the following tasks. The ACME DC routers have already tagged all the routes originated from DC1 with BGP community of 65010:1000; all the routes originated from DC2 with BGP community of 65020:2000. Please configure a route-policy to ensure the default route (0.0.0.0/0) coming from both DCs is set with an OMP tag of 100. For DC1 routes, set an OMP tag of 1000 ; for DC2 routes, set an OMP tag of 2000 . (Lab_Task 1) ACME wants to have a hub & spoke topology between the Remote sites and DCs as well as between the Remote sites and Regional hubs . The Hub & spoke topology will scale more by reducing the number of tunnels required on the devices. (Lab_Task 2) ACME has categorized their branches into multiple Business Units(BUs). In the Data Center (DC) sites, the headend WAN Edges(WEs) are also categorized into multiple BUs for the purpose of horizontal scaling in terms of throughputs, therefore remote site only needs to build tunnels to its respective DC hub WEs. Remote Site1 only needs to build tunnels to DC1-WE1 and DC2-WE1 ; Remote Site 2 only needs to build tunnels to DC1-WE2 and DC2-WE2 .(Lab_Task 2) Remote sites receive a default route from both RH and DC, **DCs will be preferred and load shared. RH's default route will be used as backup for DCs. (Lab_Task 3) Remotes sites receive more specific routes from both DCs, and routes originated from local DC are preferred . If one DC goes down, it will use the routes from another DC as backup. In another words, from remote sites perspective, previously tagged routes tagged with 1000 will prefer DC1; routes tagged with 2000 will prefer DC2.(Lab_Task 4) For remote sites to any other region, routes are forced to go through the DC\u2019s functional hub. For remote site1, it goes through WE1 in DC1 and DC2 ; for remote site 2, it goes through WE2 in DC1 and DC2 .(Lab_Task 4) Note: In these lab exercises, it's possible that there are multiple ways to achieve the requirements. The lab guide provides a detailed step by step instruction for each tasks. However you're welcome to solve it with your own solution. Just be mindful with the time. Task 1: Local Route Policy In this section, you are going to use localized policy to assign a tag for DC specific route as well as the default route. In a later section you are going to create policy based on the tag . Step 1.1 Verification of the routes received on DC WEs. SSH to DC1-WE1, DC1-WE2, DC2-WE1,DC2-WE2 and do show ip route vrf 1 and make sure 10.100.100.0/24, 10.200.200/24 as well as 0.0.0.0/0 learned via BGP. Step 1.2 Verify the BGP communities. 10.100.100.0/24 should tag with 65010:1000; 10.200.200.0/24 should tag with 65020:2000. Execute show ip bgp vpnv4 vrf 1 <prefix> (10.100.100.0/24 and 10.200.200.0/24) on DC1-WE1,DC1-WE2 and DC2-WE1,DC2-WE2. Step 1.3 set the OMP tag for DC specific Routes Login to vManage https://198.18.133.200:8443 and access policy configuration from Configuration - Policies Click Custom Options drop down on the top right and select Route Policy under Localized Policy Click Add Route Policy to Create new Name: LAB_DCs_BGP_RP (write down this name, it will be used later) Description: LAB_DCs_BGP_RP Click +Sequence Type on the left then click +Sequence Rule , click Match, select Address , select default . Click Action , change to Accept , then select OMP tag, key in 100 , then save Match and Actions. click Sequence Rule to create following two rules: Match community-list DC1_Routes , Accept and Set OMP Tag 1000 Match community-list DC2_Routes , Accept and Set OMP Tag 2000 Note: Match Criteria has option \"OR\",\"AND\" \"EXACT\". It makes difference when multiple community lists are used in match condition. In this lab, we are only match one community. You can leave it as default OR option. - Click Default Action on the left panel, and change default Reject action to Accept Then click on Save Route Policy Step 1.4 Creating a Local Policy Login to vManage 198.18.133.200 and access policy configuration from Configuration - Policies Click on Localized Policy , then click on Add Policy Click on Next to proceed till you see Configure Route Policy ; click Add Route Policy then select Import Existing Policy ; Select LAB_DCs_BGP_RP click import Click on Next, Key in the following values: Policy Name: LAB_DCs_Local_policy Policy Description: LAB_DCs_Local_policy . Check Netflow, Application and Implicit ACL Logging . Then click on Save Policy (Feel free to click Preview before save) Attach the local policy to the DC device templates (Lab_DC1_V01 & Lab_DC2_V01) Access template configuration from Configuration - Templates Under the Device template tab, locate template Lab_DC1_V01 and select Edit Under the Additional Templates section, click the dropdown next to Policy and select LAB_DCs_Local_policy Click update and Next to configuration change window. Click the checkbox to Confirm configuration changes and click OK to push the change. Under the Device template tab, locate template Lab_DC2_V01 and select Edit Under the Additional Templates section, click the dropdown next to Policy and select LAB_DCs_Local_policy Click update and Next to configuration change window. Click the checkbox to Confirm configuration changes and click OK to push the change. Note: Verify that you have attached the policy on both DC1&DC2 device-templates before proceeding to the next step. Step 1.5 Apply the route-policy Access the feature template configuration from Configuration - Templates - Feature Locate the feature template Lab_DC_VPN1_BGP_V01 and select the three dots on the right side and then click Edit . Select the Neighbor section, then click on the pencil icon under Action. Update the following: Change Address Family to Global and set to On Change Address Family to Global and set to ipv4-unicast Change Route Policy In to Global and set to On Change Policy Name changes to Global and set to LAB_DCs_BGP_RP (this was the name you wrote down earlier) Then click on Save changes and Click on Update Then click Next and then Update. Feel free to review the config changes, then click Configure Devices, then check the Confirm configuration box and click on OK. Step 1.6 Verify OMP Tags SSH to DC wEdge routers( DC1-WE1,DC1-WE2,DC2-WE1,DC2-WE2 ) and run show ip bgp vpnv4 vrf 1 <prefix> (10.100.100.0/24,10.200.200.0/24) You should see the proper OMP tags are now set to 1000 and 2000 Task 2: Hub & Spoke Topologies In this section, you are going to use a centralized policy to build the hub & spoke topology. This will include the hub on both DCs as well as RH. Step 2.1. Pre-config verifications SSH to R1-WE1 and run the show sdwan omp route vpn 1 command. Question: Do you know why the default route learned from private2 shown as invalid and unreachable (Inv,U) ? This is because R1-WE1 doesn't have a transport with private 2 color. If you check the route on R2-WE1, you should notice the next hop from private 1 marked as (Inv,U) for the same reason, because the private 1 color doesn't exist on R2-WE1. Question: Did you notice the default route is learned from 1.1.30.1 which is the Regional Hub(RH)? Do you know why? To answer this question, we will check the route table at vSmart as all the routes are advertised by vSmart. SSH to vSmart and run show omp route vpn 1 0.0.0.0/0 detail | t OMP is very much like BGP when it comes down to route preference. In the order of preference, there is an origin-protocol, in this case the default route learned on RH is from Static (by design, in real deployment, it's probably going to be BGP as well); whereas the default learned from the DCs is from iBGP. The Origin protocol static route is more preferred than iBGP. Now, let's look at the specific routes learned from DC. Do show sdwan omp route vpn 1 10.100.100.0/24 on R1-WE1 . Question: you will see 4 paths and one of the paths shows Inv,U. Hopefully you can answer why that is. But why are there 4 paths? Let's SSH to vSmart and do show omp route vpn 1 10.100.100.0/24 | t . You will see 12 ECMP routes marked as C,R (Chosen,Resolved). Why 12? This is because we have 4 DC wEdges each with 3 transports, so there are total of 12 paths. The next question will be why there are only 4 paths on the remote wEdges? This is because the ECMP settings on the wEdge by default are set to 4. If you change it to the current maximum of 16, you will see all 12 paths.(It will be increased to a maximum of 128 in a future release) Note: vSmart randomly selects 4 paths (or the max ECMP value is set to) and installs them on the device. This may pose problem in a large deployment where multiple paths is more than 16. In this exercise we will keep the default ECMP setting and solve this issue with a centralized policy. Step 2.2. Create a topology for centralized policy SSH to R1-WE1 & R2-WE1 and run show sdwan bfd sessions command and verify bfd tunnels between R1-WE1 and R2-WE1 Login to vManage 198.18.133.200 and access policy configuration from Configuration - Policies Click the Custom Options drop down on the top right and select Topology under Centralized Policy Click Add Topology under Topology and select Custom Control( Route&TLOC ) You are going to create two topologies, one for each remote site. Create the topology policy for Remote1 Name: LAB_Topo_RS1 Description: LAB topology for Remote Site 1 Click +Sequence Type and select Route Click +Sequence Rule , leave unchanged under Match(means match all) Click Actions and change to Accept (we'll come back and do the route policy later). Click Save Match And Actions to save the rule Click +Sequence Type then select TLOC Click +Sequence Rule , select TLOC for March condition Under Match Conditions , selects DCs-BU1-TLOCs for TLOC List (this TLOC list has been pre-defined for you which includes all the TLOCs of DC1-WE1 and DC2-WE1 Click Actions , change Actions to Accept Click +Sequence Rule , select TLOC Under Match Conditions , selects RH_TLOCs for TLOC List (this TLOC list has been pre-defined for you which includes all the TLOCs of RH) Click Actions , change Actions to Accept Click Save Match And Actions to save the rule Then click save Control Policy. This policy effectively allows R1-WE1 to build tunnels to all the DCs-BU1 devices (DC1-WE1 and DC2-WE1) as well as RH. Nothing else is allowed as the default action is reject. Follow the above steps and create another topology for Remote2 with the following settings: Name: LAB_Topo_RS2 Description: LAB topology for Remote Site 2 Click +Sequence Type then select Route Click +Sequence Rule , leave unchanged under Match(means match all), Click Actions change Actions to Accept (we'll come back and do the route policy later). Click +Sequence Type then select TLOC Click +Sequence Rule , select TLOC for March condition Under Match Conditions , selects DCs-BU2-TLOCs for TLOC List (this TLOC list has been pre-defined for you which includes all the TLOCs of DC1-WE2 and DC2-WE2) Click Actions , change Actions to Accept Click Save Match And Actions to save the rule Click +Sequence Rule , select TLOC Under Match Conditions , selects RH-TLOCs for TLOC List (this TLOC list has been pre-defined for you which includes all the TLOCs of RH) Click Actions , change Actions to Accept Click Save Match And Actions to save the rule Then click save Control Policy. This policy effectively allows R2-WE1 to build tunnels to all the DCs-BU2 devices (DC1-WE2 and DC2-WE2) as well as RH. Nothing else is allowed as the default action is reject. Step 2.3. Apply the topology policy to Centralized Policy Login to vManage 198.18.133.200 and access policy configuration from Configuration - Policies Click Add Policy under Centralized Policy Click next, you will see Configure Topology and VPN membership - Click Add topology , and select Import Existing Topology Click Custom Control(Route and TLOC) , then select LAB_Topo_RS1 Click on Import to add Topology Follow the steps above to add topology LAB_Topo_RS2 as well Click Next and proceed to the last step for Applying Policies to Sites and VPNs Policy Name: LAB_Central_v01 Description: Task2 Topo only Click New Site List Under LAB_Topo_RS1 , under Outbound Site List , select RS1 ,then click on Add Click New Site List Under LAB_Topo_RS2 , under Outbound Site List , select RS2 ,then click on Add then click Save Policy Step 2.4. Activate the first Centralized Policy Login to vManage 198.18.133.200 and access policy configuration from Configuration - Policies - Centralized Policy Locate policy LAB_Centeral_v01 you have created in previous step. Click ... for more options and select Activate . The policy will be pushed to the vSmarts. Step 2.5. Verify the hub & spoke topology SSH to R1-WE1 & R2-WE1 and run show sdwan bfd sessions command Verify there is no bfd session between R1-WE1 and R2-WE1 Task 3: Default Route handling In this task. you will configure the central policy to prefer the default route learned from DC over RH. You will need to modify the Centralized policy so that the default route from DC has higher OMP preference over RH. Step 3.1. New Central Policy Make a new version of the topology policy. Note: In production network, it is always recommended to create a new version when you update your policy. So that you can also change to the previous version as a fallback plan. Login to vManage 198.18.133.200 and access policy configuration from Configuration - Policies Click the Custom Options drop down on the top right and select Topology under Centralized Policy Locate policy LAB_Topo_RS1 , click ... and select Copy . - Provide a name and description for the new policy - Name: LAB_Topo_RS1_V02 - Description: +Default Route handling Step 3.2. Edit the new topology policy. Click the Custom Options drop down on the top right and select Topology under Centralized Policy Locate LAB_Topo_RS1_V02 and click ... select Edit Note: there is one existing accept all rule; you don't need to change the accept all rule but you do need make sure the new rules are placed ahead of this accept all rule. For Sequence Type Route rule, you are going to add four new rules Rule1: match Prefix List default & originator of 1.1.10.1(DC1-WE1) then accept and set preference of 100 Rule2: match default & originator of 1.1.20.1(DC2-WE1) then accept and set preference of 100 Rule3: match default & site-list RH then accept Rule4: match default and then reject Drag & drop the newly created rules to move it ahead of the previous accept all rule. Note: vSmart does the lookup based on the order. If it finds the match, it will use that rule and it won't look for any subsequent rules. Click Save Control policy . Step 3.3. Apply the policy Login to vManage 198.18.133.200 and access policy configuration from Configuration - Policies Locate centralized policy LAB_Central_v01 , click ... and select Edit Note: In production deployment, you always want to use the same practice of copying the current policy then apply it. Under Topology tab, select LAB_Topo_RS1 . Click ... and select Detach to remove this topology. Click Add Topology , select Import Existing Topology and then select LAB_Topo_RS1_V02 , and click Import. Click on Policy Application Under LAB_Topo_RS1_V02 - Outbound Site List , click New Site List and select RS1 . Click Add , Save Policy Changes to Activate. Note: The Outbound and Inbound options are from the vSmart's perspective where outbound policy means how the routes are sent out from vSmart; inbound policy means how the routes are sent to the vSmart. Step 3.4. Verify change of default route SSH to R1-WE1 and do show sdwan omp route and check the learned TLOC for the default route as well as preference. We're expecting the routes which are learned from DC1-WE1 and DC2-WE1 with preference of 100. However, the output shows the routes are not changed at all, the three installed routes are still learned from RH and no preference set either. Why is that? Let's check omp route table on the vSmart, SSH to vSmart and run show omp route | t . As you recall, the OMP routes don't have any changes either where 3 paths learned from RH are marked with C,R due to routes being originated from Static which are preferred over originated from iBGP. But why doesn't the outbound policy that is setting the routes originated from DC1-WE1 and DC2-WE1 work? This is because by default the outbound policy will only apply to the routes with \"C,R\", the routes without \"C,R\" are not applicable . So the routes from DCs are not even going through the outbound policies. There are multiple ways to change this default behavior such as using inbound policy or configure send-backup path, or make every route with C.R. In this lab, we are going to use inbound policy to influence the route. Let's configure an vSmart inbound policy to make the default routes learned from DCs have a higher OMP preference than RH's. Note: Using vSmart inbound policy may not be an ideal solution for all scenarios. It is recommended to use outbound policy, because it is simple and maintains full visibility of vSmart. vSmart inbound policy can be considered only if outbound policy can NOT meet the requirements. Step 3.5. Create new topology Login to vManage 198.18.133.200 and access policy configuration from Configuration - Policies Click Custom Options on the upper right corner and select Topology under Centralized Policy . Click Add Topology and select Custom Control(Route&TLOC) Configure the new policy with following setting Name: default_route_from_DC Description: default_route_from_DC Click +Sequence Type and select TLOC Click +Sequence Rule leave unchange Under Match Conditions (means match all) Click Actions , change action to Accept Click +Sequence Type and select Route Click +Sequence Rule Click Prefix List and Site under Match Under Match Conditions , select default from Prefix List dropdown Under Match Conditions , select DCs from Site List dropdown Click Actions select Accept ; add Preference with value 50 Click +Sequence Rule to add catch-all rule leave unchange Under Match Conditions (means match all) Click Actions select Accept ; add Preference with value 0 Click Save Match And Actions and Save Control Policy Apply this new topology to the current policy. Login to vManage 198.18.133.200 and access policy configuration from Configuration - Policies Locate LAB_Central_v01 under Centralized Policy and select Edit Click Topology tab and click Add Topology Select Import Existing Topology and select Custom Control( Route and TLOC) Policy Type then select default_route_from_DC from drop down; click Import. Click on Policy Application , click on New Site List under Inbound Site List , select DCs . Click on Add and Save Policy Changes to Activate. Note: This time there is an inbound policy where the inbound policy controls how vSmart sees the routes. Step 3.6. Verify SSH to the vSmart and run show omp route vpn 1 | t Here you will see the routes from both DCs are C,R with preference 50 now which is expected. SSH to R1-WE1 and do show sdwan omp route vpn 1 . You will see 4 paths from DCs with preference 100. Remember the vSmart outbound policy we assign preference of 100 where the inbound policy we assign preference of 50 so that we can differentiate which policy is taking effect. Well done! You have finished the default route handling task for R1-WE1.Let's configure the same policy for R2-WE1. Step 3.7. Create topology policy for Remote2 Login to vManage 198.18.133.200 and access policy configuration from Configuration - Policies Click Custom Options on the upper right corner and select Topology under Centralized Policy . Locate LAB_Topo_RS1_V02 click ... select copy and change Name and Description to LAB_Topo_RS2_v02 then click Copy. Locate newly created LAB_Topo_RS2_v02 . click ... select Edit Select TLOC as the Sequence Type; select Rule1 and click the pencil to Edit . Note: We need to change the TLOC List from BU1 to BU2 as we'd like to use the BU2's functional hub which are DC1-WE2 and DC2-WE2 as the entry point for remote site 2(Remember remote site 2 represents the remote sites for BU2, where remote site 1 represents the remote sites for BU1). Remove DCs-BU1-TLOCs by clicking the x , then select DCs-BU2-TLOCs and click Save Match and Actions . Select Route as the Sequence Type , you need to change the originator from 1.1.10.1 to 1.1.10.2 and 1.1.20.1 to 1.1.20.2 . By doing this, default route from DC1-WE2 and DC2-WE2 will have OMP preference of 100 sent to R2-WE2 site. After Save Control Policy , access the Centralized Policy from Configuration - Policies Locate LAB_Central_v01 and select Edit Under Topology tab, click Add Topology and select Import Existing Topology Change Policy Type to Custom Control( Route and TLOC ) ; select LAB_Topo_RS2_V02 and Import. Select existing topology LAB_Topo_RS2 , click detach to remove it from Centralized Policy. Click Policy Application ; under LAB_Topo_RS2_V02 click New Site List and select RS2 as outbound site list. Click Add, and Save Policy Changes to Activate. Once the policy has been pushed to vSmart, let's verify. SSH to R2-WE1 and run show ip route vrf 1 . Now, the default route has two ECMP paths, one path for each DC. - Do show sdwan omp route vpn 1 .You will see that there are 4 paths in the OMP route table, however one of them is invalid. Task 4: Specific Routes handling ACME wants to prefer more specific routes originated from its DC and use the other DC as backup. For BU1 (R1-WE1), it only needs to learn the routes from BU1's Headend devices (DC1-WE1 and DC2-WE1); for BU2(R2-WE1), it onlys need to learn the routes from BU2's Headend devices.(DC1-WE2 and DC2-WE2). The specific routes from DC1 are tagged with 1000; DC2 are tagged with 2000 in previous task. In this section, you are going to create different policies for BU1 and BU2 sites and set different OMP preference based on OMP tag. Step 4.1: Modify Topology policy for remote1 Login to vManage 198.18.133.200 and access policy configuration from Configuration - Policies Click Custom Options on the upper right corner and select Topology under Centralized Policy . Locate topology LAB_Topo_RS1_V02 . click ... and select Edit Select Route under Sequence Type , you are going to add four more rules. Rule1 Click Sequence Rule , select OMP Tag and TLOC for match condition Under Match Conditions , type 1000 in OMP Tag ; DC1-BU1-TLOCs in TLOC List Click Actions , change to Accept and set Preference of 100. Click Save Match And Actions rule2 Click Sequence Rule , select OMP Tag and TLOC for match condition Under Match Conditions , type 1000 in OMP Tag ; DC2-BU1-TLOCs in TLOC List Click Actions , change to Accept and set Preference of 50 Click Save Match And Actions rule3 Click Sequence Rule , select OMP Tag and TLOC for match condition Under Match Conditions , type 2000 in OMP Tag ; DC2-BU1-TLOCs in TLOC List Click Actions , change to Accept and set Preference of 100. Click Save Match And Actions rule4 Click Sequence Rule , select OMP Tag and TLOC for match condition Under Match Conditions , type 2000 in OMP Tag ; DC1-BU1-TLOCs in TLOC List Click Actions , change to Accept and set Preference of 50 Click Save Match And Actions Drag and Drop to move up the newly created rules above the accept all rule. (if you followed the previously task, the new rules should be No. 5, 6,7 and 8, and the match all rule should be rule No. 9) Note: vSmart does the lookup based upon the order from top down, When a match is found, it will use that rule and stop processing the sequence(it will not longer look for subsequent rules). Click Save policy to Activate. This will make the vSmart to push the policy immediately after you confirm configuring devices This is expected, creating a new policy is a best practice. Otherwise updating the existing active policy will cause an immediate policy push. To verify, SSH to R1-WE1 and run show sdwan omp route vpn 1 Here we can see 4 paths for 10.100.100.0/24, however we see 3 paths with preference of 100. One path doesn't have any preference; For 10.200.200.0/24, there are 4 paths however 3 paths have a preference of 50, one path doesn't have any preference. If you look at it closely you will notice that the paths picked are from the lowest system-ip. This is because by default vSmart will only send 4 paths to the wEdges. When vSmart is going through the outbound policy, it takes a route from vsmart route table in the winning order (marked as C,R) and compare it with the outbound policy as long as there is a match (permit) in the policy for a particular prefix, it will send it out and count it as one until it hits the send-path-limits which is 4 by default. Since in our route-policy, we have a permit all at the end which means every route will have a match, therefore first 4 routes in the winning order are sent out regardless which rule they're matching in the policy. There are multiple ways to fix this, the simple way is to change the limit to 16 on both vSmart as well as on the wEdges. Step 4.2: Configure 16 paths ECMP Configure vSmart to send 16 paths Access template configuration from Configuration - Templates Under Device template tab, locate template vSmart and select Edit Under OMP config section, add configure send-path-limit 16 . Click update to complete the configuration. Change ecmp-limit to 16 on the wEdges. Access template configuration from Configuration - Templates Under the Feature template tab, locate template Lab_OMP_V01 and select Edit Under the Basic Configuration section, change ECMP to 16 as Global variable. Click update to push configuration changes. Note: This OMP feature template is used on all device templates. Where we modify this one feature template, it will change the configuration on all devices, in our case on all 7 WAN Edges. Step 4.3: Verification SSH to R1-WE1 and run show sdwan omp route vpn 1 You should see each route for (10.100.100.0/24 and 10.200.200.0/24) will have 12 paths and 3 paths from the preferred DC with preference of 100, 3 paths from secondary DC with preference of 50, another 6 paths from are invalid from other BU hub devices. Now run show ip route vrf 1 You will see route 10.100.100.0/24 is learned from 1.1.10.1, and route 10.200.200.0/24 is learned from 1.1.20.1 which is desired. Step 4.4: Modify Topology policy for remote2 Login to vManage 198.18.133.200 and access policy configuration from Configuration - Policies Click Custom Options on the upper right corner and select Topology under Centralized Policy . locate topology LAB_Topo_RS2_V02 . click ... and select Edit Select Route under Sequence Type . Here you are going to add four more rules. Rule1: Click Sequence Rule , select OMP Tag and then TLOC for match condition Under Match Conditions , type 1000 in OMP Tag ; DC1-BU2-TLOCs in TLOC List Click Actions , change to Accept and set the Preference of 100. Click Save Match And Actions Rule2: Click Sequence Rule , select OMP Tag and then TLOC for match condition Under Match Conditions , type 1000 in OMP Tag ; DC2-BU2-TLOCs in TLOC List Click Actions , change to Accept and set the Preference of 50 Click Save Match And Actions Rule3: Click Sequence Rule , select OMP Tag and then TLOC for match condition Under Match Conditions , type 2000 in OMP Tag ; DC2-BU2-TLOCs in TLOC List Click Actions , change to Accept and set the Preference of 100. Click Save Match And Actions Rule4: Click Sequence Rule , select OMP Tag and then TLOC for match condition Under Match Conditions , type 2000 in OMP Tag ; DC1-BU2-TLOCs in TLOC List Click Actions , change to Accept and set the Preference of 50 Click Save Match And Actions Drag and Drop to move up the newly created rules above the accept all rule. (if you followed the previous tasks, the new rules should be No. 5, 6,7 and 8, match all rule should be rule No. 9) Note: vSmart does the lookup based on the order from top down. When a match is found, it will use that rule and stop processing the sequence (it will no longer look for subsequent rules). click Save policy to Activate. This will make the vSmart to push the policy immediately after you confirm configuring devices This is expected, creating a new policy is a best practice. Otherwise updating the existing active policy will cause an immediate policy push. Step 4.5: Verification SSH to R2-WE1 and run show sdwan omp route vpn 1 Here you can see each route (10.100.100.0/24 and 10.200.200.0/24) will have 12 paths - however 3 paths from the preferred DC have a preference of 100, 3 paths from the secondary DC have a preference of 50, and another 6 paths from are invalid from other BU hub devices. Run show ip route vrf 1 Here you will see 10.100.100.0/24 is learned from 1.1.10.2; 10.200.200.0/24 is learned from 1.1.20.2 which is desired. This concludes the routing handling for the specific routes. Task 5: Application Aware Routing ACME wants to provide the best user experience for their transactional data which has to meet the below SLA requirement ( we will use SSH to simulate this). ACME would also like to use private 1 as the preferred link, if private 1 doesn't meet the SLA requirement, it will use private 2 when private 2 still meets the SLA. The LTE link will only be used when both private 1 and private 2 go down. ACME has the following SLA requirements for their applications. Application Loss(%) Lattency(msec) Jitter(msec) Transactional Data 5 50 100 Bulk-Data 10 300 100 Voice-and-Video 2 45 30 Default 25 300 100 Solution: Application Aware Routing (AAR) is one of the differentiator between SDWAN and traditional WAN technology where you can route traffic based upon an application's SLA. You can classify an application based upon traditional 5 tuples or even application's DPI(Deep Packet Inspection). There three action keyword for the selected application. Prefer; backup and strict. The key to remember is AAR is all about SLA. Prefer means when the preferred color/s meets the SLA, this/these colors will be preferred. If all the preferred colors don't meet the SLA, then depending on if you have backup or strict configuration, these two options are mutual exclusive. If the backup color is configured which means when preferred color doesn't meet SLA, it will first use all other colors that meet the SLA regardless if that color is configured as backup or not (as long as the color meets the SLA). If there are multiple such colors, it will perform load sharing among them. If none of the colors meet the SLAs, it will use the configured backup color. If strict is configured (note: strict and backup are mutual exclusive ), the matching traffic will be dropped when the preferred color is not configured. Based upon the requirements, we will do the following: first configure LTE as the last resort which means it won't come up until all other circuits are not available. Then we will configure private1 as preferred color, and we simply don't need to mention private2 (because if private2 meets the SLA it will be used anyway). If private2 doesn't meet SLA, since neither strict nor backup is configured, it will simply use any available tunnels that are left. Step 5.1: Configure the RH LTE interface be used only when all other circuits are unavailable. Access template configuration from Configuration - Templates Under Feature template tab, locate template Lab_RH_VPN0_LTE_V01 and select Edit Under the Tunnel section, expand Advanced Options Change Last-Resort Circuit to Device Specific and give it the variable name vpn_if_tunnel_last_resort_circuit . Click Update to trigger device configure change. Select vpn_if_tunnel_last_resort_circuit checkbox and Update to push configure change This setting will make LTE the last-resort which means the interface will go down, and no other traffic use it until all other circuits become unavailable. Step 5.2: Last-Resort verification. SSH to RH-WE and run show ip int brief Here you will notice Gig3 and Tunnel3 are both down. Run show sdwan control connections . Notice there is no control connections on the LTE interface. Run show sdwan bfd sessions . Notice there is no IPSec tunnel over LTE either. Step 5.3: Configure SLA classes for app aware routing (AAR) Login to vManage 198.18.133.200 and access policy configuration from Configuration - Policies Click Custom Options drop down on the top right and select Lists under Centralized Policy Select SLA Class and confirm the classes are defined properly. Click Custom Options drop down on the top right and select Traffic Policy under Centralized Policy Select Application Aware Routing and Add Policy to create new Configure the AAR policy with the setting below: Name: LAB_AAR_V01 Description: LAB_AAR_V01 click +Sequence Type and click Sequence Rule select Destination Port for Match condition under Match Conditions , type 22 in destination port click Actions , select SLA Class List and Counter under Actions SLA Class: Transactional-Data Preferred Color: private1 Counter: transactional-data Click Save Match And Actions Click 'Save Application Aware Routing Policy' Step 5.4: Apply the AAR Access policy configuration from Configuration - Policies Locate LAB_Central_v01 click ... for more option and select Copy Name the new policy LAB_Central_v02 Select the new policy LAB_Central_v02 , click ... for more option and select Edit Under Traffic Rules - Application Aware Routing , click Add Policy then Import Existing , select LAB_AAR_V01 and Import. Click Policy Application tab then select Application Aware Routing Click New Site List and VPN List to add it New Site List: DCs and RH VPN List: VPN1 Click on Add then Save Policy Changes Activate LAB_Central_v02 policy by clicking ... and select activate . Step 5.5: Lab Verification Login to vManage 198.18.133.200 and select Monitor - Network from the left panel Click RH-WE1 to bring up the device monitor page, and select Troubleshooting from the panel on the left Select Simulate Flows tool under Traffic and use the following value for simulated flow VPN: VPN-1 Source/Interface for VPN-1: Gigabithernet4 - ipv4 - 10.10.30.2 Source IP: 10.10.30.2 Destination IP: 10.100.100.100 Click on Advanced Options : Protocol: 6 (TCP) Destination Port: 22 All Paths: Checked Click Simulate You should see the traffic is only taking the private1 path which means it's using private1 as the preferred transport. Do another simulation, this time change the destination port to 23, everything else remains the same. You should see the traffic will use both private1 and private2 which means it uses all available circuits for all other traffic. Now let's shutdown the private1 interface of the RH-WE1 and verify again. Access template configuration from Configuration - Templates Locate device template Lab_RH_V01 , click ... and select Change Device Values Click ... to select Edit Device Template Select the Shutdown(vpn_if_interface) checkbox under GigabitEthernet1 Click Update -> next to trigger the configuration change. Now let's verify it again. Login to vManage 198.18.133.200 and select Monitor - Network Click RH-WE1 to bring up device monitor page, and select Troubleshooting from the panel on the left Select Simulate Flows tool under Traffic and use the following value for simulated flow VPN: VPN-1 Source/Interface for VPN-1: Gigabitethernet4 - ipv4 - 10.10.30.2 Source IP: 10.10.30.2 Destination IP: 10.100.100.100 Click on Advanced Options : Protocol: 6 (TCP) Destination Port: 22 All Paths: Checked Click Simulate You should see that traffic is only taking the private2 path now as this is the only color available. Let's shutdown private2 interface and verify again Access the Template configuration from Configuration - Templates Locate device template Lab_RH_V01 , click ... and select Change Device Values Click ... to select Edit Device Template Select the Shutdown(vpn_if_interface) checkbox under GigabitEthernet2 Click Update -> next to trigger the configuration change. Now let's verify it again. Login to vManage 198.18.133.200 and select Monitor - Network Click RH-WE1 to bring up the device monitor page, and select Troubleshooting from the panel on the left Select Simulate Flows tool under Traffic and use the following value for simulated flow VPN: VPN-1 Source/Interface for VPN-1: Gigabitethernet4 - ipv4 - 10.10.30.2 Source IP: 10.10.30.2 Destination IP: 10.100.100.100 Click on Advanced Options : Protocol: 6 (TCP) Destination Port: 22 All Paths: Checked Click Simulate You should see the traffic is taking LTE interface only. Great! You've completed lab1. Before you proceed to next lab, let's no shutdown private1 and private2 interfaces, and disable LTE last-resort by changing the device value of RH-WE1's device template. Back to Top","title":"Lab 1 Tasks"},{"location":"lab1/#lab-1-advanced-routing","text":"In this section, you will help ACME on an advanced routing using both local and central policy. You will perform the following tasks. The ACME DC routers have already tagged all the routes originated from DC1 with BGP community of 65010:1000; all the routes originated from DC2 with BGP community of 65020:2000. Please configure a route-policy to ensure the default route (0.0.0.0/0) coming from both DCs is set with an OMP tag of 100. For DC1 routes, set an OMP tag of 1000 ; for DC2 routes, set an OMP tag of 2000 . (Lab_Task 1) ACME wants to have a hub & spoke topology between the Remote sites and DCs as well as between the Remote sites and Regional hubs . The Hub & spoke topology will scale more by reducing the number of tunnels required on the devices. (Lab_Task 2) ACME has categorized their branches into multiple Business Units(BUs). In the Data Center (DC) sites, the headend WAN Edges(WEs) are also categorized into multiple BUs for the purpose of horizontal scaling in terms of throughputs, therefore remote site only needs to build tunnels to its respective DC hub WEs. Remote Site1 only needs to build tunnels to DC1-WE1 and DC2-WE1 ; Remote Site 2 only needs to build tunnels to DC1-WE2 and DC2-WE2 .(Lab_Task 2) Remote sites receive a default route from both RH and DC, **DCs will be preferred and load shared. RH's default route will be used as backup for DCs. (Lab_Task 3) Remotes sites receive more specific routes from both DCs, and routes originated from local DC are preferred . If one DC goes down, it will use the routes from another DC as backup. In another words, from remote sites perspective, previously tagged routes tagged with 1000 will prefer DC1; routes tagged with 2000 will prefer DC2.(Lab_Task 4) For remote sites to any other region, routes are forced to go through the DC\u2019s functional hub. For remote site1, it goes through WE1 in DC1 and DC2 ; for remote site 2, it goes through WE2 in DC1 and DC2 .(Lab_Task 4) Note: In these lab exercises, it's possible that there are multiple ways to achieve the requirements. The lab guide provides a detailed step by step instruction for each tasks. However you're welcome to solve it with your own solution. Just be mindful with the time.","title":"Lab 1: Advanced Routing"},{"location":"lab1/#task-1-local-route-policy","text":"In this section, you are going to use localized policy to assign a tag for DC specific route as well as the default route. In a later section you are going to create policy based on the tag .","title":"Task 1: Local Route Policy"},{"location":"lab1/#step-11-verification-of-the-routes-received-on-dc-wes","text":"SSH to DC1-WE1, DC1-WE2, DC2-WE1,DC2-WE2 and do show ip route vrf 1 and make sure 10.100.100.0/24, 10.200.200/24 as well as 0.0.0.0/0 learned via BGP.","title":"Step 1.1 Verification of the routes received on DC WEs."},{"location":"lab1/#step-12-verify-the-bgp-communities","text":"10.100.100.0/24 should tag with 65010:1000; 10.200.200.0/24 should tag with 65020:2000. Execute show ip bgp vpnv4 vrf 1 <prefix> (10.100.100.0/24 and 10.200.200.0/24) on DC1-WE1,DC1-WE2 and DC2-WE1,DC2-WE2.","title":"Step 1.2 Verify the BGP communities."},{"location":"lab1/#step-13-set-the-omp-tag-for-dc-specific-routes","text":"Login to vManage https://198.18.133.200:8443 and access policy configuration from Configuration - Policies Click Custom Options drop down on the top right and select Route Policy under Localized Policy Click Add Route Policy to Create new Name: LAB_DCs_BGP_RP (write down this name, it will be used later) Description: LAB_DCs_BGP_RP Click +Sequence Type on the left then click +Sequence Rule , click Match, select Address , select default . Click Action , change to Accept , then select OMP tag, key in 100 , then save Match and Actions. click Sequence Rule to create following two rules: Match community-list DC1_Routes , Accept and Set OMP Tag 1000 Match community-list DC2_Routes , Accept and Set OMP Tag 2000 Note: Match Criteria has option \"OR\",\"AND\" \"EXACT\". It makes difference when multiple community lists are used in match condition. In this lab, we are only match one community. You can leave it as default OR option. - Click Default Action on the left panel, and change default Reject action to Accept Then click on Save Route Policy","title":"Step 1.3 set the OMP tag for DC specific Routes"},{"location":"lab1/#step-14-creating-a-local-policy","text":"Login to vManage 198.18.133.200 and access policy configuration from Configuration - Policies Click on Localized Policy , then click on Add Policy Click on Next to proceed till you see Configure Route Policy ; click Add Route Policy then select Import Existing Policy ; Select LAB_DCs_BGP_RP click import Click on Next, Key in the following values: Policy Name: LAB_DCs_Local_policy Policy Description: LAB_DCs_Local_policy . Check Netflow, Application and Implicit ACL Logging . Then click on Save Policy (Feel free to click Preview before save) Attach the local policy to the DC device templates (Lab_DC1_V01 & Lab_DC2_V01) Access template configuration from Configuration - Templates Under the Device template tab, locate template Lab_DC1_V01 and select Edit Under the Additional Templates section, click the dropdown next to Policy and select LAB_DCs_Local_policy Click update and Next to configuration change window. Click the checkbox to Confirm configuration changes and click OK to push the change. Under the Device template tab, locate template Lab_DC2_V01 and select Edit Under the Additional Templates section, click the dropdown next to Policy and select LAB_DCs_Local_policy Click update and Next to configuration change window. Click the checkbox to Confirm configuration changes and click OK to push the change. Note: Verify that you have attached the policy on both DC1&DC2 device-templates before proceeding to the next step.","title":"Step 1.4 Creating a Local Policy"},{"location":"lab1/#step-15-apply-the-route-policy","text":"Access the feature template configuration from Configuration - Templates - Feature Locate the feature template Lab_DC_VPN1_BGP_V01 and select the three dots on the right side and then click Edit . Select the Neighbor section, then click on the pencil icon under Action. Update the following: Change Address Family to Global and set to On Change Address Family to Global and set to ipv4-unicast Change Route Policy In to Global and set to On Change Policy Name changes to Global and set to LAB_DCs_BGP_RP (this was the name you wrote down earlier) Then click on Save changes and Click on Update Then click Next and then Update. Feel free to review the config changes, then click Configure Devices, then check the Confirm configuration box and click on OK.","title":"Step 1.5 Apply the route-policy"},{"location":"lab1/#step-16-verify-omp-tags","text":"SSH to DC wEdge routers( DC1-WE1,DC1-WE2,DC2-WE1,DC2-WE2 ) and run show ip bgp vpnv4 vrf 1 <prefix> (10.100.100.0/24,10.200.200.0/24) You should see the proper OMP tags are now set to 1000 and 2000","title":"Step 1.6 Verify OMP Tags"},{"location":"lab1/#task-2-hub-spoke-topologies","text":"In this section, you are going to use a centralized policy to build the hub & spoke topology. This will include the hub on both DCs as well as RH.","title":"Task 2: Hub &amp; Spoke Topologies"},{"location":"lab1/#step-21-pre-config-verifications","text":"SSH to R1-WE1 and run the show sdwan omp route vpn 1 command. Question: Do you know why the default route learned from private2 shown as invalid and unreachable (Inv,U) ? This is because R1-WE1 doesn't have a transport with private 2 color. If you check the route on R2-WE1, you should notice the next hop from private 1 marked as (Inv,U) for the same reason, because the private 1 color doesn't exist on R2-WE1. Question: Did you notice the default route is learned from 1.1.30.1 which is the Regional Hub(RH)? Do you know why? To answer this question, we will check the route table at vSmart as all the routes are advertised by vSmart. SSH to vSmart and run show omp route vpn 1 0.0.0.0/0 detail | t OMP is very much like BGP when it comes down to route preference. In the order of preference, there is an origin-protocol, in this case the default route learned on RH is from Static (by design, in real deployment, it's probably going to be BGP as well); whereas the default learned from the DCs is from iBGP. The Origin protocol static route is more preferred than iBGP. Now, let's look at the specific routes learned from DC. Do show sdwan omp route vpn 1 10.100.100.0/24 on R1-WE1 . Question: you will see 4 paths and one of the paths shows Inv,U. Hopefully you can answer why that is. But why are there 4 paths? Let's SSH to vSmart and do show omp route vpn 1 10.100.100.0/24 | t . You will see 12 ECMP routes marked as C,R (Chosen,Resolved). Why 12? This is because we have 4 DC wEdges each with 3 transports, so there are total of 12 paths. The next question will be why there are only 4 paths on the remote wEdges? This is because the ECMP settings on the wEdge by default are set to 4. If you change it to the current maximum of 16, you will see all 12 paths.(It will be increased to a maximum of 128 in a future release) Note: vSmart randomly selects 4 paths (or the max ECMP value is set to) and installs them on the device. This may pose problem in a large deployment where multiple paths is more than 16. In this exercise we will keep the default ECMP setting and solve this issue with a centralized policy.","title":"Step 2.1. Pre-config verifications"},{"location":"lab1/#step-22-create-a-topology-for-centralized-policy","text":"SSH to R1-WE1 & R2-WE1 and run show sdwan bfd sessions command and verify bfd tunnels between R1-WE1 and R2-WE1 Login to vManage 198.18.133.200 and access policy configuration from Configuration - Policies Click the Custom Options drop down on the top right and select Topology under Centralized Policy Click Add Topology under Topology and select Custom Control( Route&TLOC ) You are going to create two topologies, one for each remote site. Create the topology policy for Remote1 Name: LAB_Topo_RS1 Description: LAB topology for Remote Site 1 Click +Sequence Type and select Route Click +Sequence Rule , leave unchanged under Match(means match all) Click Actions and change to Accept (we'll come back and do the route policy later). Click Save Match And Actions to save the rule Click +Sequence Type then select TLOC Click +Sequence Rule , select TLOC for March condition Under Match Conditions , selects DCs-BU1-TLOCs for TLOC List (this TLOC list has been pre-defined for you which includes all the TLOCs of DC1-WE1 and DC2-WE1 Click Actions , change Actions to Accept Click +Sequence Rule , select TLOC Under Match Conditions , selects RH_TLOCs for TLOC List (this TLOC list has been pre-defined for you which includes all the TLOCs of RH) Click Actions , change Actions to Accept Click Save Match And Actions to save the rule Then click save Control Policy. This policy effectively allows R1-WE1 to build tunnels to all the DCs-BU1 devices (DC1-WE1 and DC2-WE1) as well as RH. Nothing else is allowed as the default action is reject. Follow the above steps and create another topology for Remote2 with the following settings: Name: LAB_Topo_RS2 Description: LAB topology for Remote Site 2 Click +Sequence Type then select Route Click +Sequence Rule , leave unchanged under Match(means match all), Click Actions change Actions to Accept (we'll come back and do the route policy later). Click +Sequence Type then select TLOC Click +Sequence Rule , select TLOC for March condition Under Match Conditions , selects DCs-BU2-TLOCs for TLOC List (this TLOC list has been pre-defined for you which includes all the TLOCs of DC1-WE2 and DC2-WE2) Click Actions , change Actions to Accept Click Save Match And Actions to save the rule Click +Sequence Rule , select TLOC Under Match Conditions , selects RH-TLOCs for TLOC List (this TLOC list has been pre-defined for you which includes all the TLOCs of RH) Click Actions , change Actions to Accept Click Save Match And Actions to save the rule Then click save Control Policy. This policy effectively allows R2-WE1 to build tunnels to all the DCs-BU2 devices (DC1-WE2 and DC2-WE2) as well as RH. Nothing else is allowed as the default action is reject.","title":"Step 2.2. Create a topology for centralized policy"},{"location":"lab1/#step-23-apply-the-topology-policy-to-centralized-policy","text":"Login to vManage 198.18.133.200 and access policy configuration from Configuration - Policies Click Add Policy under Centralized Policy Click next, you will see Configure Topology and VPN membership - Click Add topology , and select Import Existing Topology Click Custom Control(Route and TLOC) , then select LAB_Topo_RS1 Click on Import to add Topology Follow the steps above to add topology LAB_Topo_RS2 as well Click Next and proceed to the last step for Applying Policies to Sites and VPNs Policy Name: LAB_Central_v01 Description: Task2 Topo only Click New Site List Under LAB_Topo_RS1 , under Outbound Site List , select RS1 ,then click on Add Click New Site List Under LAB_Topo_RS2 , under Outbound Site List , select RS2 ,then click on Add then click Save Policy","title":"Step 2.3. Apply the topology policy to Centralized Policy"},{"location":"lab1/#step-24-activate-the-first-centralized-policy","text":"Login to vManage 198.18.133.200 and access policy configuration from Configuration - Policies - Centralized Policy Locate policy LAB_Centeral_v01 you have created in previous step. Click ... for more options and select Activate . The policy will be pushed to the vSmarts.","title":"Step 2.4. Activate the first Centralized Policy"},{"location":"lab1/#step-25-verify-the-hub-spoke-topology","text":"SSH to R1-WE1 & R2-WE1 and run show sdwan bfd sessions command Verify there is no bfd session between R1-WE1 and R2-WE1","title":"Step 2.5. Verify the hub &amp; spoke topology"},{"location":"lab1/#task-3-default-route-handling","text":"In this task. you will configure the central policy to prefer the default route learned from DC over RH. You will need to modify the Centralized policy so that the default route from DC has higher OMP preference over RH.","title":"Task 3: Default Route handling"},{"location":"lab1/#step-31-new-central-policy","text":"Make a new version of the topology policy. Note: In production network, it is always recommended to create a new version when you update your policy. So that you can also change to the previous version as a fallback plan. Login to vManage 198.18.133.200 and access policy configuration from Configuration - Policies Click the Custom Options drop down on the top right and select Topology under Centralized Policy Locate policy LAB_Topo_RS1 , click ... and select Copy . - Provide a name and description for the new policy - Name: LAB_Topo_RS1_V02 - Description: +Default Route handling","title":"Step 3.1.  New Central Policy"},{"location":"lab1/#step-32-edit-the-new-topology-policy","text":"Click the Custom Options drop down on the top right and select Topology under Centralized Policy Locate LAB_Topo_RS1_V02 and click ... select Edit Note: there is one existing accept all rule; you don't need to change the accept all rule but you do need make sure the new rules are placed ahead of this accept all rule. For Sequence Type Route rule, you are going to add four new rules Rule1: match Prefix List default & originator of 1.1.10.1(DC1-WE1) then accept and set preference of 100 Rule2: match default & originator of 1.1.20.1(DC2-WE1) then accept and set preference of 100 Rule3: match default & site-list RH then accept Rule4: match default and then reject Drag & drop the newly created rules to move it ahead of the previous accept all rule. Note: vSmart does the lookup based on the order. If it finds the match, it will use that rule and it won't look for any subsequent rules. Click Save Control policy .","title":"Step 3.2. Edit the new topology policy."},{"location":"lab1/#step-33-apply-the-policy","text":"Login to vManage 198.18.133.200 and access policy configuration from Configuration - Policies Locate centralized policy LAB_Central_v01 , click ... and select Edit Note: In production deployment, you always want to use the same practice of copying the current policy then apply it. Under Topology tab, select LAB_Topo_RS1 . Click ... and select Detach to remove this topology. Click Add Topology , select Import Existing Topology and then select LAB_Topo_RS1_V02 , and click Import. Click on Policy Application Under LAB_Topo_RS1_V02 - Outbound Site List , click New Site List and select RS1 . Click Add , Save Policy Changes to Activate. Note: The Outbound and Inbound options are from the vSmart's perspective where outbound policy means how the routes are sent out from vSmart; inbound policy means how the routes are sent to the vSmart.","title":"Step 3.3. Apply the policy"},{"location":"lab1/#step-34-verify-change-of-default-route","text":"SSH to R1-WE1 and do show sdwan omp route and check the learned TLOC for the default route as well as preference. We're expecting the routes which are learned from DC1-WE1 and DC2-WE1 with preference of 100. However, the output shows the routes are not changed at all, the three installed routes are still learned from RH and no preference set either. Why is that? Let's check omp route table on the vSmart, SSH to vSmart and run show omp route | t . As you recall, the OMP routes don't have any changes either where 3 paths learned from RH are marked with C,R due to routes being originated from Static which are preferred over originated from iBGP. But why doesn't the outbound policy that is setting the routes originated from DC1-WE1 and DC2-WE1 work? This is because by default the outbound policy will only apply to the routes with \"C,R\", the routes without \"C,R\" are not applicable . So the routes from DCs are not even going through the outbound policies. There are multiple ways to change this default behavior such as using inbound policy or configure send-backup path, or make every route with C.R. In this lab, we are going to use inbound policy to influence the route. Let's configure an vSmart inbound policy to make the default routes learned from DCs have a higher OMP preference than RH's. Note: Using vSmart inbound policy may not be an ideal solution for all scenarios. It is recommended to use outbound policy, because it is simple and maintains full visibility of vSmart. vSmart inbound policy can be considered only if outbound policy can NOT meet the requirements.","title":"Step 3.4. Verify change of default route"},{"location":"lab1/#step-35-create-new-topology","text":"Login to vManage 198.18.133.200 and access policy configuration from Configuration - Policies Click Custom Options on the upper right corner and select Topology under Centralized Policy . Click Add Topology and select Custom Control(Route&TLOC) Configure the new policy with following setting Name: default_route_from_DC Description: default_route_from_DC Click +Sequence Type and select TLOC Click +Sequence Rule leave unchange Under Match Conditions (means match all) Click Actions , change action to Accept Click +Sequence Type and select Route Click +Sequence Rule Click Prefix List and Site under Match Under Match Conditions , select default from Prefix List dropdown Under Match Conditions , select DCs from Site List dropdown Click Actions select Accept ; add Preference with value 50 Click +Sequence Rule to add catch-all rule leave unchange Under Match Conditions (means match all) Click Actions select Accept ; add Preference with value 0 Click Save Match And Actions and Save Control Policy Apply this new topology to the current policy. Login to vManage 198.18.133.200 and access policy configuration from Configuration - Policies Locate LAB_Central_v01 under Centralized Policy and select Edit Click Topology tab and click Add Topology Select Import Existing Topology and select Custom Control( Route and TLOC) Policy Type then select default_route_from_DC from drop down; click Import. Click on Policy Application , click on New Site List under Inbound Site List , select DCs . Click on Add and Save Policy Changes to Activate. Note: This time there is an inbound policy where the inbound policy controls how vSmart sees the routes.","title":"Step 3.5. Create new topology"},{"location":"lab1/#step-36-verify","text":"SSH to the vSmart and run show omp route vpn 1 | t Here you will see the routes from both DCs are C,R with preference 50 now which is expected. SSH to R1-WE1 and do show sdwan omp route vpn 1 . You will see 4 paths from DCs with preference 100. Remember the vSmart outbound policy we assign preference of 100 where the inbound policy we assign preference of 50 so that we can differentiate which policy is taking effect. Well done! You have finished the default route handling task for R1-WE1.Let's configure the same policy for R2-WE1.","title":"Step 3.6. Verify"},{"location":"lab1/#step-37-create-topology-policy-for-remote2","text":"Login to vManage 198.18.133.200 and access policy configuration from Configuration - Policies Click Custom Options on the upper right corner and select Topology under Centralized Policy . Locate LAB_Topo_RS1_V02 click ... select copy and change Name and Description to LAB_Topo_RS2_v02 then click Copy. Locate newly created LAB_Topo_RS2_v02 . click ... select Edit Select TLOC as the Sequence Type; select Rule1 and click the pencil to Edit . Note: We need to change the TLOC List from BU1 to BU2 as we'd like to use the BU2's functional hub which are DC1-WE2 and DC2-WE2 as the entry point for remote site 2(Remember remote site 2 represents the remote sites for BU2, where remote site 1 represents the remote sites for BU1). Remove DCs-BU1-TLOCs by clicking the x , then select DCs-BU2-TLOCs and click Save Match and Actions . Select Route as the Sequence Type , you need to change the originator from 1.1.10.1 to 1.1.10.2 and 1.1.20.1 to 1.1.20.2 . By doing this, default route from DC1-WE2 and DC2-WE2 will have OMP preference of 100 sent to R2-WE2 site. After Save Control Policy , access the Centralized Policy from Configuration - Policies Locate LAB_Central_v01 and select Edit Under Topology tab, click Add Topology and select Import Existing Topology Change Policy Type to Custom Control( Route and TLOC ) ; select LAB_Topo_RS2_V02 and Import. Select existing topology LAB_Topo_RS2 , click detach to remove it from Centralized Policy. Click Policy Application ; under LAB_Topo_RS2_V02 click New Site List and select RS2 as outbound site list. Click Add, and Save Policy Changes to Activate. Once the policy has been pushed to vSmart, let's verify. SSH to R2-WE1 and run show ip route vrf 1 . Now, the default route has two ECMP paths, one path for each DC. - Do show sdwan omp route vpn 1 .You will see that there are 4 paths in the OMP route table, however one of them is invalid.","title":"Step 3.7. Create topology policy for Remote2"},{"location":"lab1/#task-4-specific-routes-handling","text":"ACME wants to prefer more specific routes originated from its DC and use the other DC as backup. For BU1 (R1-WE1), it only needs to learn the routes from BU1's Headend devices (DC1-WE1 and DC2-WE1); for BU2(R2-WE1), it onlys need to learn the routes from BU2's Headend devices.(DC1-WE2 and DC2-WE2). The specific routes from DC1 are tagged with 1000; DC2 are tagged with 2000 in previous task. In this section, you are going to create different policies for BU1 and BU2 sites and set different OMP preference based on OMP tag.","title":"Task 4: Specific Routes handling"},{"location":"lab1/#step-41-modify-topology-policy-for-remote1","text":"Login to vManage 198.18.133.200 and access policy configuration from Configuration - Policies Click Custom Options on the upper right corner and select Topology under Centralized Policy . Locate topology LAB_Topo_RS1_V02 . click ... and select Edit Select Route under Sequence Type , you are going to add four more rules. Rule1 Click Sequence Rule , select OMP Tag and TLOC for match condition Under Match Conditions , type 1000 in OMP Tag ; DC1-BU1-TLOCs in TLOC List Click Actions , change to Accept and set Preference of 100. Click Save Match And Actions rule2 Click Sequence Rule , select OMP Tag and TLOC for match condition Under Match Conditions , type 1000 in OMP Tag ; DC2-BU1-TLOCs in TLOC List Click Actions , change to Accept and set Preference of 50 Click Save Match And Actions rule3 Click Sequence Rule , select OMP Tag and TLOC for match condition Under Match Conditions , type 2000 in OMP Tag ; DC2-BU1-TLOCs in TLOC List Click Actions , change to Accept and set Preference of 100. Click Save Match And Actions rule4 Click Sequence Rule , select OMP Tag and TLOC for match condition Under Match Conditions , type 2000 in OMP Tag ; DC1-BU1-TLOCs in TLOC List Click Actions , change to Accept and set Preference of 50 Click Save Match And Actions Drag and Drop to move up the newly created rules above the accept all rule. (if you followed the previously task, the new rules should be No. 5, 6,7 and 8, and the match all rule should be rule No. 9) Note: vSmart does the lookup based upon the order from top down, When a match is found, it will use that rule and stop processing the sequence(it will not longer look for subsequent rules). Click Save policy to Activate. This will make the vSmart to push the policy immediately after you confirm configuring devices This is expected, creating a new policy is a best practice. Otherwise updating the existing active policy will cause an immediate policy push. To verify, SSH to R1-WE1 and run show sdwan omp route vpn 1 Here we can see 4 paths for 10.100.100.0/24, however we see 3 paths with preference of 100. One path doesn't have any preference; For 10.200.200.0/24, there are 4 paths however 3 paths have a preference of 50, one path doesn't have any preference. If you look at it closely you will notice that the paths picked are from the lowest system-ip. This is because by default vSmart will only send 4 paths to the wEdges. When vSmart is going through the outbound policy, it takes a route from vsmart route table in the winning order (marked as C,R) and compare it with the outbound policy as long as there is a match (permit) in the policy for a particular prefix, it will send it out and count it as one until it hits the send-path-limits which is 4 by default. Since in our route-policy, we have a permit all at the end which means every route will have a match, therefore first 4 routes in the winning order are sent out regardless which rule they're matching in the policy. There are multiple ways to fix this, the simple way is to change the limit to 16 on both vSmart as well as on the wEdges.","title":"Step 4.1: Modify Topology policy for remote1"},{"location":"lab1/#step-42-configure-16-paths-ecmp","text":"Configure vSmart to send 16 paths Access template configuration from Configuration - Templates Under Device template tab, locate template vSmart and select Edit Under OMP config section, add configure send-path-limit 16 . Click update to complete the configuration. Change ecmp-limit to 16 on the wEdges. Access template configuration from Configuration - Templates Under the Feature template tab, locate template Lab_OMP_V01 and select Edit Under the Basic Configuration section, change ECMP to 16 as Global variable. Click update to push configuration changes. Note: This OMP feature template is used on all device templates. Where we modify this one feature template, it will change the configuration on all devices, in our case on all 7 WAN Edges.","title":"Step 4.2: Configure 16 paths ECMP"},{"location":"lab1/#step-43-verification","text":"SSH to R1-WE1 and run show sdwan omp route vpn 1 You should see each route for (10.100.100.0/24 and 10.200.200.0/24) will have 12 paths and 3 paths from the preferred DC with preference of 100, 3 paths from secondary DC with preference of 50, another 6 paths from are invalid from other BU hub devices. Now run show ip route vrf 1 You will see route 10.100.100.0/24 is learned from 1.1.10.1, and route 10.200.200.0/24 is learned from 1.1.20.1 which is desired.","title":"Step 4.3: Verification"},{"location":"lab1/#step-44-modify-topology-policy-for-remote2","text":"Login to vManage 198.18.133.200 and access policy configuration from Configuration - Policies Click Custom Options on the upper right corner and select Topology under Centralized Policy . locate topology LAB_Topo_RS2_V02 . click ... and select Edit Select Route under Sequence Type . Here you are going to add four more rules. Rule1: Click Sequence Rule , select OMP Tag and then TLOC for match condition Under Match Conditions , type 1000 in OMP Tag ; DC1-BU2-TLOCs in TLOC List Click Actions , change to Accept and set the Preference of 100. Click Save Match And Actions Rule2: Click Sequence Rule , select OMP Tag and then TLOC for match condition Under Match Conditions , type 1000 in OMP Tag ; DC2-BU2-TLOCs in TLOC List Click Actions , change to Accept and set the Preference of 50 Click Save Match And Actions Rule3: Click Sequence Rule , select OMP Tag and then TLOC for match condition Under Match Conditions , type 2000 in OMP Tag ; DC2-BU2-TLOCs in TLOC List Click Actions , change to Accept and set the Preference of 100. Click Save Match And Actions Rule4: Click Sequence Rule , select OMP Tag and then TLOC for match condition Under Match Conditions , type 2000 in OMP Tag ; DC1-BU2-TLOCs in TLOC List Click Actions , change to Accept and set the Preference of 50 Click Save Match And Actions Drag and Drop to move up the newly created rules above the accept all rule. (if you followed the previous tasks, the new rules should be No. 5, 6,7 and 8, match all rule should be rule No. 9) Note: vSmart does the lookup based on the order from top down. When a match is found, it will use that rule and stop processing the sequence (it will no longer look for subsequent rules). click Save policy to Activate. This will make the vSmart to push the policy immediately after you confirm configuring devices This is expected, creating a new policy is a best practice. Otherwise updating the existing active policy will cause an immediate policy push.","title":"Step 4.4: Modify Topology policy for remote2"},{"location":"lab1/#step-45-verification","text":"SSH to R2-WE1 and run show sdwan omp route vpn 1 Here you can see each route (10.100.100.0/24 and 10.200.200.0/24) will have 12 paths - however 3 paths from the preferred DC have a preference of 100, 3 paths from the secondary DC have a preference of 50, and another 6 paths from are invalid from other BU hub devices. Run show ip route vrf 1 Here you will see 10.100.100.0/24 is learned from 1.1.10.2; 10.200.200.0/24 is learned from 1.1.20.2 which is desired.","title":"Step 4.5: Verification"},{"location":"lab1/#this-concludes-the-routing-handling-for-the-specific-routes","text":"","title":"This concludes the routing handling for the specific routes."},{"location":"lab1/#task-5-application-aware-routing","text":"ACME wants to provide the best user experience for their transactional data which has to meet the below SLA requirement ( we will use SSH to simulate this). ACME would also like to use private 1 as the preferred link, if private 1 doesn't meet the SLA requirement, it will use private 2 when private 2 still meets the SLA. The LTE link will only be used when both private 1 and private 2 go down. ACME has the following SLA requirements for their applications. Application Loss(%) Lattency(msec) Jitter(msec) Transactional Data 5 50 100 Bulk-Data 10 300 100 Voice-and-Video 2 45 30 Default 25 300 100 Solution: Application Aware Routing (AAR) is one of the differentiator between SDWAN and traditional WAN technology where you can route traffic based upon an application's SLA. You can classify an application based upon traditional 5 tuples or even application's DPI(Deep Packet Inspection). There three action keyword for the selected application. Prefer; backup and strict. The key to remember is AAR is all about SLA. Prefer means when the preferred color/s meets the SLA, this/these colors will be preferred. If all the preferred colors don't meet the SLA, then depending on if you have backup or strict configuration, these two options are mutual exclusive. If the backup color is configured which means when preferred color doesn't meet SLA, it will first use all other colors that meet the SLA regardless if that color is configured as backup or not (as long as the color meets the SLA). If there are multiple such colors, it will perform load sharing among them. If none of the colors meet the SLAs, it will use the configured backup color. If strict is configured (note: strict and backup are mutual exclusive ), the matching traffic will be dropped when the preferred color is not configured. Based upon the requirements, we will do the following: first configure LTE as the last resort which means it won't come up until all other circuits are not available. Then we will configure private1 as preferred color, and we simply don't need to mention private2 (because if private2 meets the SLA it will be used anyway). If private2 doesn't meet SLA, since neither strict nor backup is configured, it will simply use any available tunnels that are left.","title":"Task 5: Application Aware Routing"},{"location":"lab1/#step-51-configure-the-rh-lte-interface-be-used-only-when-all-other-circuits-are-unavailable","text":"Access template configuration from Configuration - Templates Under Feature template tab, locate template Lab_RH_VPN0_LTE_V01 and select Edit Under the Tunnel section, expand Advanced Options Change Last-Resort Circuit to Device Specific and give it the variable name vpn_if_tunnel_last_resort_circuit . Click Update to trigger device configure change. Select vpn_if_tunnel_last_resort_circuit checkbox and Update to push configure change This setting will make LTE the last-resort which means the interface will go down, and no other traffic use it until all other circuits become unavailable.","title":"Step 5.1: Configure the RH LTE interface be used only when all other circuits are unavailable."},{"location":"lab1/#step-52-last-resort-verification","text":"SSH to RH-WE and run show ip int brief Here you will notice Gig3 and Tunnel3 are both down. Run show sdwan control connections . Notice there is no control connections on the LTE interface. Run show sdwan bfd sessions . Notice there is no IPSec tunnel over LTE either.","title":"Step 5.2: Last-Resort verification."},{"location":"lab1/#step-53-configure-sla-classes-for-app-aware-routing-aar","text":"Login to vManage 198.18.133.200 and access policy configuration from Configuration - Policies Click Custom Options drop down on the top right and select Lists under Centralized Policy Select SLA Class and confirm the classes are defined properly. Click Custom Options drop down on the top right and select Traffic Policy under Centralized Policy Select Application Aware Routing and Add Policy to create new Configure the AAR policy with the setting below: Name: LAB_AAR_V01 Description: LAB_AAR_V01 click +Sequence Type and click Sequence Rule select Destination Port for Match condition under Match Conditions , type 22 in destination port click Actions , select SLA Class List and Counter under Actions SLA Class: Transactional-Data Preferred Color: private1 Counter: transactional-data Click Save Match And Actions Click 'Save Application Aware Routing Policy'","title":"Step 5.3: Configure SLA classes for app aware routing (AAR)"},{"location":"lab1/#step-54-apply-the-aar","text":"Access policy configuration from Configuration - Policies Locate LAB_Central_v01 click ... for more option and select Copy Name the new policy LAB_Central_v02 Select the new policy LAB_Central_v02 , click ... for more option and select Edit Under Traffic Rules - Application Aware Routing , click Add Policy then Import Existing , select LAB_AAR_V01 and Import. Click Policy Application tab then select Application Aware Routing Click New Site List and VPN List to add it New Site List: DCs and RH VPN List: VPN1 Click on Add then Save Policy Changes Activate LAB_Central_v02 policy by clicking ... and select activate .","title":"Step 5.4: Apply the AAR"},{"location":"lab1/#step-55-lab-verification","text":"Login to vManage 198.18.133.200 and select Monitor - Network from the left panel Click RH-WE1 to bring up the device monitor page, and select Troubleshooting from the panel on the left Select Simulate Flows tool under Traffic and use the following value for simulated flow VPN: VPN-1 Source/Interface for VPN-1: Gigabithernet4 - ipv4 - 10.10.30.2 Source IP: 10.10.30.2 Destination IP: 10.100.100.100 Click on Advanced Options : Protocol: 6 (TCP) Destination Port: 22 All Paths: Checked Click Simulate You should see the traffic is only taking the private1 path which means it's using private1 as the preferred transport. Do another simulation, this time change the destination port to 23, everything else remains the same. You should see the traffic will use both private1 and private2 which means it uses all available circuits for all other traffic. Now let's shutdown the private1 interface of the RH-WE1 and verify again. Access template configuration from Configuration - Templates Locate device template Lab_RH_V01 , click ... and select Change Device Values Click ... to select Edit Device Template Select the Shutdown(vpn_if_interface) checkbox under GigabitEthernet1 Click Update -> next to trigger the configuration change. Now let's verify it again. Login to vManage 198.18.133.200 and select Monitor - Network Click RH-WE1 to bring up device monitor page, and select Troubleshooting from the panel on the left Select Simulate Flows tool under Traffic and use the following value for simulated flow VPN: VPN-1 Source/Interface for VPN-1: Gigabitethernet4 - ipv4 - 10.10.30.2 Source IP: 10.10.30.2 Destination IP: 10.100.100.100 Click on Advanced Options : Protocol: 6 (TCP) Destination Port: 22 All Paths: Checked Click Simulate You should see that traffic is only taking the private2 path now as this is the only color available. Let's shutdown private2 interface and verify again Access the Template configuration from Configuration - Templates Locate device template Lab_RH_V01 , click ... and select Change Device Values Click ... to select Edit Device Template Select the Shutdown(vpn_if_interface) checkbox under GigabitEthernet2 Click Update -> next to trigger the configuration change. Now let's verify it again. Login to vManage 198.18.133.200 and select Monitor - Network Click RH-WE1 to bring up the device monitor page, and select Troubleshooting from the panel on the left Select Simulate Flows tool under Traffic and use the following value for simulated flow VPN: VPN-1 Source/Interface for VPN-1: Gigabitethernet4 - ipv4 - 10.10.30.2 Source IP: 10.10.30.2 Destination IP: 10.100.100.100 Click on Advanced Options : Protocol: 6 (TCP) Destination Port: 22 All Paths: Checked Click Simulate You should see the traffic is taking LTE interface only. Great! You've completed lab1. Before you proceed to next lab, let's no shutdown private1 and private2 interfaces, and disable LTE last-resort by changing the device value of RH-WE1's device template. Back to Top","title":"Step 5.5: Lab Verification"},{"location":"lab2/","text":"Lab 2: Route to the legacy site In this section, you will help ACME to configure routing between sd-wan remote sites and legacy non sd-wan site. The legacy site is connected to SP private1 with OSPF as CE-PE protocol. Legacy site prefix 10.11.1.0/24 is advertised to private1 PE router; DC WAN Edge routers are receiving this prefix from service side over BGP. To make sure traffic between sd-wan remotes and legacy site using optimal path, ACME requires SD-WAN site Remote2 uses DC as transit site to reach legacy site over private2. SD-WAN site Remote1 route directly over private 1 to legacy site. Step1: Verify current route SSH into ubuntu host in Remote1 and Remote2. R1-VM1 198.18.133.200:19018 R2-VM1 198.18.133.200:19019 Run route command to verify default route is pointing to eth0 interface as shown below. Note If default route is missing on the VM, please run command sudo route add default gw 10.10.102.1 eth0 to add default route. Run traceroute 10.11.1.1 from both hosts as show in below screenshots As show from the traceroute, ubuntu host from both remote sites are using DC as transit site to reach prefix 10.11.1.0/24 from legacy site. Step2: Route policy for Remote2 The requirement for remote2 is to use DC as transit site and use transport private2 . To achieve that, you can modify the central policy created in lab1 to set higher OMP preference for prefix 10.11.1.0/24 from color private2 . Login to vManage 198.18.133.200 and access policy configuration from Configuration - Policies Click Custom Options on the upper right corner and select Lists under Centralized Policy as show below. Select Prefix and click New Prefix List to add prefix 10.11.1.0/24 for legacy site as show below. Click Add to save new prefix list Legacy_prefix . Click Custom Options on the upper right corner and select Topology under Centralized Policy . Select Topology policy LAB_Topo_RS2_v02 created in lab1, and click the \"...\" to Edit. Select Route under Sequence Type from the left. Click Sequence Rule to add new rule. Add Prefix List and Color List in Match conditions Under Match Conditions, select Legacy_prefix for Prefix List and private2 for color list Click Actions to select Accept . click Preference set Preference 200. Click Save Match And Actions to save the rule Save Control Policy to Activate the change Note: After save, move the new created rule above the catch all rule by drag and drop the sequence number left to the rule . SSH into R2-WE1 and run show sdwan omp route vpn 1 . Verify preference 200 is assigned to private2 color for prefix 10.11.1.0/24 Run traceroute 10.11.1.1 again from Remote2 host and compare the path from previous output. Note: a clear arp might be needed if your output doesn't match the screenshot below Step3: Route policy for Remote1 The requirement for remote1 is to use private1 route directly to legacy site. To achieve that, you can leak prefix 10.11.1.0/24 from VPN0 into service VPN. SP private1 uses OSPF as PE-CE routing protocol; create OSPF feature template and attach to R1-WE1 VPN0. Login to vManage 198.18.133.200 and access feature template from Configuration - Template then click Feature Click Add Template , pick CSR1000v under Select Devices and select Cisco OSPF template as show below. Name the template: Lab_OSPF_VPN0_V01 Assign Router ID: 1.1.100.1 Add connected as protocol under REDISTRIBUTE section Enable OSPF Area 0 on interface GigabitEthernet1 Note: Please make sure remove \"/\" from interface dropdown list, so the interface name matches GigabitEthernet1 Save the OSPF feature template Access device template from Configuration - Template then locate template Lab_R1_V01 . Click \"...\" for more option and select Edit. Move to Transport & Management VPN section, Add Cisco OSPF template and select Lab_OSPF_VPN0_V01 from dropdown list. Update the device template and trigger vManage to update R1-VE1 configuration. After vManage complete the configuration push, SSH into R1-WE1 to verify new OSPF neighbor and routes learned from OSPF neighbor. Repeat the above steps to add OSPF for template Lab_R2_V01 . ( Note OSPF neighbor is not being configured for Remote2 in the lab) Configure route leaking between VPN0 and service VPN, so R1-WE1 will use the OSPF route learned from VPN0 for prefix 10.11.1.0/24 Login to vManage 198.18.133.200 and access feature template from Configuration - Template then click Feature Locate existing template \"Lab_Remote_VPN1_V01\" . Click \"...\" for more option and select Edit. Move to Global Route Leak section. Add OSPF under Add New Route Leak from Global VPN to Service VPN Add connected under Add New Route Leak from Service VPN to Global VPN Update the template to trigger configuration push from vManage to R1-WE1 Note: You can also add route policy to limit the routes being leaked between Global and service VPN SSH into R1-WE1 to verify route 10.10.101.0/24 being added in global route table SSH into R1-WE1 to verify route 10.11.1.0/24 being added in VRF 1 route table. The SP prefixes 172.1.x.0 are also leaked into service VPN which can be limited from additional route policy in previous step. Now let's verify the new route path from remote1 Ubuntu host. Run traceroute 10.11.1.1 again from Remote1 host and compare the result from previous output. Great! You've completed lab2. Back to Top","title":"Lab 2 Tasks"},{"location":"lab2/#lab-2-route-to-the-legacy-site","text":"In this section, you will help ACME to configure routing between sd-wan remote sites and legacy non sd-wan site. The legacy site is connected to SP private1 with OSPF as CE-PE protocol. Legacy site prefix 10.11.1.0/24 is advertised to private1 PE router; DC WAN Edge routers are receiving this prefix from service side over BGP. To make sure traffic between sd-wan remotes and legacy site using optimal path, ACME requires SD-WAN site Remote2 uses DC as transit site to reach legacy site over private2. SD-WAN site Remote1 route directly over private 1 to legacy site.","title":"Lab 2: Route to the legacy site"},{"location":"lab2/#step1-verify-current-route","text":"SSH into ubuntu host in Remote1 and Remote2. R1-VM1 198.18.133.200:19018 R2-VM1 198.18.133.200:19019 Run route command to verify default route is pointing to eth0 interface as shown below. Note If default route is missing on the VM, please run command sudo route add default gw 10.10.102.1 eth0 to add default route. Run traceroute 10.11.1.1 from both hosts as show in below screenshots As show from the traceroute, ubuntu host from both remote sites are using DC as transit site to reach prefix 10.11.1.0/24 from legacy site.","title":"Step1: Verify current route"},{"location":"lab2/#step2-route-policy-for-remote2","text":"The requirement for remote2 is to use DC as transit site and use transport private2 . To achieve that, you can modify the central policy created in lab1 to set higher OMP preference for prefix 10.11.1.0/24 from color private2 . Login to vManage 198.18.133.200 and access policy configuration from Configuration - Policies Click Custom Options on the upper right corner and select Lists under Centralized Policy as show below. Select Prefix and click New Prefix List to add prefix 10.11.1.0/24 for legacy site as show below. Click Add to save new prefix list Legacy_prefix . Click Custom Options on the upper right corner and select Topology under Centralized Policy . Select Topology policy LAB_Topo_RS2_v02 created in lab1, and click the \"...\" to Edit. Select Route under Sequence Type from the left. Click Sequence Rule to add new rule. Add Prefix List and Color List in Match conditions Under Match Conditions, select Legacy_prefix for Prefix List and private2 for color list Click Actions to select Accept . click Preference set Preference 200. Click Save Match And Actions to save the rule Save Control Policy to Activate the change Note: After save, move the new created rule above the catch all rule by drag and drop the sequence number left to the rule . SSH into R2-WE1 and run show sdwan omp route vpn 1 . Verify preference 200 is assigned to private2 color for prefix 10.11.1.0/24 Run traceroute 10.11.1.1 again from Remote2 host and compare the path from previous output. Note: a clear arp might be needed if your output doesn't match the screenshot below","title":"Step2: Route policy for Remote2"},{"location":"lab2/#step3-route-policy-for-remote1","text":"The requirement for remote1 is to use private1 route directly to legacy site. To achieve that, you can leak prefix 10.11.1.0/24 from VPN0 into service VPN. SP private1 uses OSPF as PE-CE routing protocol; create OSPF feature template and attach to R1-WE1 VPN0. Login to vManage 198.18.133.200 and access feature template from Configuration - Template then click Feature Click Add Template , pick CSR1000v under Select Devices and select Cisco OSPF template as show below. Name the template: Lab_OSPF_VPN0_V01 Assign Router ID: 1.1.100.1 Add connected as protocol under REDISTRIBUTE section Enable OSPF Area 0 on interface GigabitEthernet1 Note: Please make sure remove \"/\" from interface dropdown list, so the interface name matches GigabitEthernet1 Save the OSPF feature template Access device template from Configuration - Template then locate template Lab_R1_V01 . Click \"...\" for more option and select Edit. Move to Transport & Management VPN section, Add Cisco OSPF template and select Lab_OSPF_VPN0_V01 from dropdown list. Update the device template and trigger vManage to update R1-VE1 configuration. After vManage complete the configuration push, SSH into R1-WE1 to verify new OSPF neighbor and routes learned from OSPF neighbor. Repeat the above steps to add OSPF for template Lab_R2_V01 . ( Note OSPF neighbor is not being configured for Remote2 in the lab) Configure route leaking between VPN0 and service VPN, so R1-WE1 will use the OSPF route learned from VPN0 for prefix 10.11.1.0/24 Login to vManage 198.18.133.200 and access feature template from Configuration - Template then click Feature Locate existing template \"Lab_Remote_VPN1_V01\" . Click \"...\" for more option and select Edit. Move to Global Route Leak section. Add OSPF under Add New Route Leak from Global VPN to Service VPN Add connected under Add New Route Leak from Service VPN to Global VPN Update the template to trigger configuration push from vManage to R1-WE1 Note: You can also add route policy to limit the routes being leaked between Global and service VPN SSH into R1-WE1 to verify route 10.10.101.0/24 being added in global route table SSH into R1-WE1 to verify route 10.11.1.0/24 being added in VRF 1 route table. The SP prefixes 172.1.x.0 are also leaked into service VPN which can be limited from additional route policy in previous step. Now let's verify the new route path from remote1 Ubuntu host. Run traceroute 10.11.1.1 again from Remote1 host and compare the result from previous output. Great! You've completed lab2. Back to Top","title":"Step3: Route policy for Remote1"},{"location":"lab3/","text":"Lab 3: Performance Optimization In this section, you will help ACME to optimize their SD-WAN fabric. You will perform the following tasks in this lab. Add QoS and make sure consistent QoS policies are applied across the SD-WAN fabric. Regional hub has higher bandwidth on WAN circuits compare to remote sites. This bandwidth mismatch could potentially cause packet drops on remote sites. Configure the sd-wan fabric to prevent this potential issue. Due to the latency sensitive application requirement, a spoke to spoke tunnel is needed between remote sites. Configure the sd-wan fabric to build on-demand tunnel between remote sites. Cloud Application (16.16.16.16) requires inspection services for all users. Configure IPSec tunnel to SIG provider for inspection services and configure the sd-wan fabric to route all traffic to this application over a IPSec tunnel. ACME wants to reduce the bandwidth consumption on private WAN links. Configure the sd-wan fabric to route public cloud and Internet traffic over local internet access. For SaaS application, configure the sd-wan fabric to use either local DIA or RH based on application performance. Task 1: QoS Enabling QoS has three main steps: classification, marking and queueing. Queueing policy is configured as Localized policy and applied on interface level. classification and marking can be enabled over Localized policy or over centralized data policy. ACME requires consistent QoS policies across sd-wan fabric, you will use centralized data policy to achieve that. ACME uses 4-class QoS model with the following policy requirements. Class Applications DSCP Value Queueing REALTIME Real Time Protocol,webex,zoom 46 30% SIGNALING rtcp,mgcp,sip 24 10% CRITICAL SSH,SNMP,SMB 26 40% DEFAULT 0 20% Step 1.1: class map and applications Login to vManage 198.18.133.200 and access policy configuration from Configuration - Policies Click Custom Options drop down on the top right and select Lists under Localized Policy Click Class Map list type on the left and add New Class List . In the pop up window enter REALTIME in Class filed, and select 0 from Queue dropdown. After save REALTIME class, add following three classes. Class: SIGNALING Queue: 1 Class: DEFAULT Queue: 2 Class: CRITICAL Queue: 3 Click Custom Options drop down on the top right and select Lists under Centralized Policy Click Application list type on the left and add New Application List . In the application configure window enter REAL TIME in Application List Name, and select \" RTP(Real Time Protocol) , WebEX , Zoom \" from Application drop list. After save \"REALTIME\" Application, add following two Applications Application List Name: SIGNALING Application: Real Time Control Protocol, Media Gateway Control Protocol, Session Initiation Protocol Application List Name: CRITICAL Application: Secure Shell, Simple Network Management Protocol, SMB Step 1.2: Central Data Policy for classification Login to vManage 198.18.133.200 and access policy configuration from Configuration - Policies Click Custom Options drop down on the top right and select Traffic Policy under Centralized Policy Select Traffic Data and select Add Policy to Create New data policy Enter Lab_QoS_v01 in Name and Description Click +Sequence Type and select QoS for new data policy type Add +Sequence Rule for following Match Conditions and Actions Application/Application Family List: REALTIME , Action Accept and Forwarding Class: REALTIME Application/Application Family List: SIGNALING , Action Accept and Forwarding Class: SIGNALING Application/Application Family List: CRITICAL , Action Accept and Forwarding Class: CRITICAL Default Match Conditions (match any): Forwarding Class: DEFAULT After Save Data Policy , go back to the Centralized Policy configuration and edit central policy LAB_Central_V02 Click Traffic Rules tab on the top then click Traffic Data and select Import Existing to add QoS data policy Lab_QoS_v01 Click Policy Application tab on the top then click Traffic Data to assign the qos data policy. To have consistent QoS policy for the fabric, We will apply the QoS policy to all sites and all VPNs on service side as show in below screenshot. Click Add and Save Policy Changes then Active the updated central policy. Step 1.3: Local QoS queuing policy Login to vManage 198.18.133.200 and access policy configuration from Configuration - Policies Click Custom Options drop down on the top right and select forwarding Class/QoS under Localized Policy Select QoS Map and select Add QoS Map to create new queuing policy Lab_QoS_Map_v01 Click Add Queue to add policy for SIGNALING class as show below. Click Add Queue to add policy for CRITICAL class as show below Click Add Queue to add policy for DEFAULT class as show below The QoS queuing policy will look similar to screenshot below. After queuing policy is created, save the queueing policy. Then you will create localized policy that includes the queueing policy. Note: To save time, We will only create local policy for remote sites in this lab. Click Localized Policy tab and Add Policy Click Next move to configure Forwarding Classes/QoS Click Add QoS Map drop down and select import existing. Search Lab_QoS_Map_v01 and Import. Click next proceeding to Policy Overview. Type LAB_Remote_Local_v01 in Policy Name and Description filed. Check Netflow and Application at the bottom from Policy Settings and Save Policy Step 1.4: Apply QoS queuing policy Applying QoS queuing policy is two step process, first you need to associate the localized policy to the device template, and next you need reference the queueing policy-map on transport interface. Access template configuration from Configuration - Templates Under Device template tab, locate template Lab_R1_V01 and select Edit Associate Lab_Remote_Local_V01 localized policy to the template as show below Click Update to push the new localized policy configuration. Repeat the above steps to associate policy for template Lab_R2_V01 Now you have the localized policy associated with device template for both remotes. Next you need reference the queueing policy on transport interfaces. Access template configuration from Configuration - Templates Under Feature template tab, locate template Lab_Remote_VPN0_Private1_v01 and select Edit Under ACL/QOS section, hardcode Lab_QoS_Map_v01 for QoS Map field. click update to push configuration change. Repeat the above steps to update Lab_Remote_VPN0_Private2_V01 and Lab_Remote_VPN0_LTE_V01 feature templates. After queuing policy is applied on both transport interfaces, you can verify the QoS policy from CLI using command show policy-map interface R2-WE1#show policy-map interface GigabitEthernet 2 GigabitEthernet2 Service-policy output: Lab_QoS_Map_v01 queue stats for all priority classes: Queueing priority level 1 queue limit 512 packets (queue depth/total drops/no-buffer drops) 0/0/0 (pkts output/bytes output) 22647/6060238 Class-map: Queue0 (match-any) 22647 packets, 6060238 bytes 30 second offered rate 15000 bps, drop rate 0000 bps Match: qos-group 0 police: rate 30 % rate 300000000 bps, burst 9375000 bytes conformed 22647 packets, 6060238 bytes; actions: transmit exceeded 0 packets, 0 bytes; actions: drop conformed 15000 bps, exceeded 0000 bps Priority: Strict, b/w exceed drops: 0 Priority Level: 1 Class-map: Queue1 (match-any) 0 packets, 0 bytes 30 second offered rate 0000 bps, drop rate 0000 bps Match: qos-group 1 Queueing queue limit 1041 packets (queue depth/total drops/no-buffer drops) 0/0/0 (pkts output/bytes output) 0/0 bandwidth remaining ratio 10 Class-map: Queue3 (match-any) 10268 packets, 1197729 bytes 30 second offered rate 0000 bps, drop rate 0000 bps Match: qos-group 3 Queueing queue limit 1041 packets (queue depth/total drops/no-buffer drops) 0/0/0 (pkts output/bytes output) 10268/1197729 bandwidth remaining ratio 40 Class-map: class-default (match-any) 15 packets, 1609 bytes 30 second offered rate 0000 bps, drop rate 0000 bps Match: any Queueing queue limit 1041 packets (queue depth/total drops/no-buffer drops) 0/0/0 (pkts output/bytes output) 15/1609 bandwidth remaining ratio 20 Exp-weight-constant: 9 (1/512) Mean queue depth: 0 packets class Transmitted Random drop Tail drop Minimum Maximum Mark pkts/bytes pkts/bytes pkts/bytes thresh thresh prob 0 1/349 0/0 0/0 260 520 1/10 1 0/0 0/0 0/0 292 520 1/10 2 0/0 0/0 0/0 325 520 1/10 3 0/0 0/0 0/0 357 520 1/10 4 0/0 0/0 0/0 390 520 1/10 5 0/0 0/0 0/0 422 520 1/10 6 14/1260 0/0 0/0 455 520 1/10 7 0/0 0/0 0/0 487 520 1/10 Task 2: per-tunnel QoS In this section, you will configure the RH WAN edge router ( RH-WE1 ) to shape tunnel traffic to each remote. This per-tunnel QoS will make sure RH cannot send excessive traffic to remotes and overrun it. Step 2.1: Configure QoS policy on RH In task 1, you have configured QoS policy on remote sites. Follow the same steps to configure QoS policy on RH RH-WE1 . Login to vManage 198.18.133.200 and access policy configuration from Configuration - Policies - Localized Policy Copy policy LAB_Remote_Local_v01 and name new policy LAB_RH_Local_v01 . Access template configuration from Configuration - Templates Locate device template Lab_RH_V01 and attach localized policy LAB_RH_Local_v01 to the device template. Update following feature templates Lab_RH_VPN0_Private1_v01 Lab_RH_VPN0_Private2_V01 Lab_RH_VPN0_LTE_V01 Under ACL/QOS section, hardcode Lab_QoS_Map_v01 for QoS Map field. Note: To avoid configuration push for each feature template update, you can make a copy for each feature template, update on new feature templates, then associate the new feature templates on device template. . Step 2.2: Configure Hub role on RH Access template configuration from Configuration - Templates Under Feature template tab, locate template Lab_RH_VPN0_Private1_v01 and select Edit Configure teh following under TUNNEL section Select On for Per-tunnel QoS to enable per-tunnel QoS Select On for Per-tunnel QoS Aggregator to set this as hub tunnel Configure Tunnel Bandwidth Percent to 80 to set maximum bandwidth usage for overlay traffic Click update to push configuration change Locate feature template Lab_RH_VPN0_Private2_V01 , and select Edit Configure teh following under TUNNEL section Select On for Per-tunnel QoS to enable per-tunnel QoS Select On for Per-tunnel QoS Aggregator to set this as hub tunnel Configure Tunnel Bandwidth Percent to 80 to set maximum bandwidth usage for overlay traffic Click update to push configuration change Step 2.3: Configure Spoke role on Remotes Access template configuration from Configuration - Templates Under Feature template tab, locate template Lab_Remote_VPN0_Private1_v01 and select Edit Under TUNNEL section, configure On for Per-tunnel QoS to enable per-tunnel QoS. Since this is spoke, we will leave Per-tunnel QoS Aggregator off. To configure a device as spoke role, you will also need to configure the downstream bandwidth. In the same feature template Lab_Remote_VPN0_Private1_v01 , under BASIC CONFIGURATION section Specify the downstream bandwidth to 10Mbps for remote1 Click update to push configuration change locate template Lab_Remote_VPN0_Private2_v01 and select Edit Under TUNNEL section, configure On for Per-tunnel QoS to enable per-tunnel QoS. Since this is spoke, we will leave Per-tunnel QoS Aggregator off. To configure a device as spoke role, you will also need to configure the downstream bandwidth. In the same feature template Lab_Remote_VPN0_Private2_v01 , under BASIC CONFIGURATION section Specify the downstream bandwidth to 20Mbps for remote2 Click update to push configuration change Step 2.4: Verify per-tunnel QOS SSH into RH-WE1 , run show platform software sdwan qos policy and show platform software sdwan qos target to verify per-tunnel QoS is working as configured. RH-WE1#show platform software sdwan qos policy ============ Session QoS Policy Database ============ policy bandwidth remaining-ratio template SDWANPolicy4210704 10000000 1 Lab_QoS_Map_v01 SDWANPolicy4210705 20000000 2 Lab_QoS_Map_v01 RH-WE1#show platform software sdwan qos target ============ Session QoS Target Database ============ src-addr dst-addr sport dport proto remote-tloc dummy-intf tunnel policy bandwidth 172.1.7.2 172.1.8.2 12346 12346 IPSEC 1.1.100.1 SDWANSession4210704 Tunnel1 SDWANPolicy4210704 10000 172.2.6.2 172.2.7.2 12346 12346 IPSEC 1.1.102.1 SDWANSession4210705 Tunnel2 SDWANPolicy4210705 20000 From the show outputs, you can find the system creates two new Hierarchical QoS Policy Maps, one for each remote site. The parent level shaper rate is equal to the downstream bandwidth you configured in previous step. Task 3: On-demand Tunnel Hub and Spoke topology can reduce the CPU and memory usage on WAN Edge, but sometime a spoke to spoke tunnel is needed. Dynamic on-demand tunnel offers the benefits of having direct spoke to spoke tunnel while keep the low CPU and memory usage on WAN Edge. To improve latency of traffic between remotes, configure dynamic on-demand tunnel between remote1 and remote2. Step 3.1: Modify central control policy In Lab1 you have created hub and spoke topology for both remote sites. In order to create dynamic on-demand tunnel between remotes, first you need modify the topology policy to include a tloc-action backup action. Login to vManage 198.18.133.200 and access policy configuration from Configuration - Policies Click Custom Options drop down on the top right and select Topology under Centralized Policy Highlight topology policy LAB_Topo_RS1_V02 and select Edit Click TLOC from Sequence Type on the left Click Sequence Rule to add a new rule; configure the rule to match on site list All-Remotes , Actions Accept . Save Match And Actions to add this new rule. Click Route from Sequence Type on the left Click Sequence Rule to add a new rule; configure the rule to match on site list All-Remotes , Actions TLOC list RH_TLOCs and TLOC Action Backup . After Save Match and And Actions , drag and drop the newly created rule to seq # 1. Click Save Control Policy to push policy update Follow the same steps to modify topology policy LAB_Topo_RS2_v02 . Step 3.2: Configure On-demand Tunnel Enable Traffic Engineering service on RH to allow RH as backup path. Access template configuration from Configuration - Templates Under Feature template tab, locate template Lab_RH_VPN0_v01 and select Edit Under SERVICE section, click New Service and select TE from service type drop down to add it to this feature template. Update to push configure change. On remote sites, R1-WE1 and R2-WE2, enable on-demand on system template. Under Feature template tab, locate template Lab_System_V01 and select Copy Name new system template Lab_Remote_System_V01 Edit Lab_Remote_System_V01 to enable On-demand Tunnel Locate device template Lab_R1_V01 and change system template to Lab_Remote_System_V01 Update to push configuration change. Locate device template Lab_R2_V01 and change system template to Lab_Remote_System_V01 . Update to push configuration change. Step 3.3: Verify On-demand Tunnel between remotes You can verify the dynamic tunnel between remotes from vManage. Login to vManage 198.18.133.200 and access Monitor - Network Select WAN-Edge R1-WE1 Click Real Time and type in on demand local in Device Options filed The output shows local on demand tunnel is enabled and status is active. Type in on demand remote in Device Options filed The output shows remote on demand tunnel to remote2 1.1.102.1 is enabled and tunnel status is inactive Dynamic on demand tunnel is triggered by traffic between the local and remote sites. That's why you see status of on demand remote is inactive. Let's generate bi-directional traffic between remote1 and remote2 to trigger on demand tunnel. ssh into R1-VM1 (the Ubuntu host), and run ssh 10.10.102.10 to login R2-VM2 with credential viptela/viptela Welcome to Ubuntu 16.04.2 LTS (GNU/Linux 4.8.0-36-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage 689 packages can be updated. 475 updates are security updates. Last login: Mon Feb 8 09:22:21 2021 from 10.16.22.163 viptela@remote1_ubuntu:~$ ssh 10.10.102.10 viptela@10.10.102.10's password: Welcome to Ubuntu 16.04.2 LTS (GNU/Linux 4.8.0-36-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage 711 packages can be updated. 521 updates are security updates. Last login: Mon Feb 8 09:25:00 2021 from 10.10.101.10 viptela@remote2_ubuntu:~$ - Go back to vManage - Monitor - Network - R1-WE1 - Real time and type in on demand remote in Device Options filed. - verify the tunnel status for on demand tunnel to remote2 1.1.102.1 changes active <img src=\"https://ciscolivelab.github.io/LTRENT-2314/img/lab3_3_3_5.PNG\" width=\"1800\"/> Task 4: IPsec tunnel to SIG Inspection service is required for traffic to cloud application with IP 16.16.16.16 . Configure remote1 and remote2 to build an IPSec tunnel to SIG provider. Route all traffic to 16.16.16.16 for inspection. Step 4.1 : Manual IPSec tunnel to SIG Before configuring the IPSec tunnel, verify the connectivity to Cloud application at 16.16.16.16 from remote ubuntu hosts. It is expected to see the application is not reachable. viptela@remote1_ubuntu:~$ ping 16.16.16.16 PING 16.16.16.16 (16.16.16.16) 56(84) bytes of data. Configure IPSec tunnel on remote1 and remote2 to match the pre-configured tunnel at SIG provider. site tunnel IP tunnel source tunnel destination IKE version pre-share key Remote1 172.4.101.1/24 GigabitEthernet2 172.3.2.2 IKE v1 cisco123 Remote2 172.4.102.1/24 GigabitEthernet2 172.3.2.2 IKE v1 cisco123 Isakmp policy encryption algorithm: AES - Advanced Encryption Standard (256 bit keys). hash algorithm: Secure Hash Standard authentication method: Pre-Shared Key Diffie-Hellman group: #16 (4096 bit) lifetime: 14400 seconds, no volume limit IPSec policy Security association lifetime:3600 seconds PFS (Y/N): Y DH group: group16 Mixed-mode : Disabled Transform sets=esp-aes esp-sha-hmac Antireplay window size = 512 - Login to vManage 198.18.133.200 and access template configuration from Configuration - Templates - Feature - Add new IPsec interface feature template for CSR1000v as show below Configure the template with following fields and leave other fields as default value filed name value Template Name Lab_IPsec_Int_V01 Description Lab_IPsec_Int_V01 Shutdown No Interface Name ipsec1 IPv4 address ipsec_tun_ip source Interface IPsec Source Interface GigabitEthernet2 IPsec Destination IP Address 172.3.2.2 Preshared Key cisco123 Add tunnel feature template Lab_IPsec_Int_V01 to device template Lab_R1_V01 and Lab_R2_V01 Locate device template Lab_R1_V01 click Edit Add Lab_IPsec_Int_V01 under VPN0 Click save to update and filed in 172.4.101.1/24 for tunnel IP Address Click Update to configure device Locate device template Lab_R2_V01 click Edit Add Lab_IPsec_Int_V01 under VPN0 Click save to update and filed in 172.4.102.1/24 for tunnel IP Address Click Update to configure device The ipsec tunnel will come UP on both remote sites. You can verify the tunnel status from show ip interface brief R2-WE1#sh ip int b Interface IP-Address OK? Method Status Protocol GigabitEthernet1 172.2.7.2 YES other up up GigabitEthernet2 172.3.9.7 YES DHCP up up GigabitEthernet3 unassigned YES other down down GigabitEthernet4 10.10.102.1 YES other up up GigabitEthernet5 unassigned YES other down down GigabitEthernet6 unassigned YES other down down GigabitEthernet7 unassigned YES other down down GigabitEthernet8 192.168.150.19 YES other up up Sdwan-system-intf 1.1.102.1 YES unset up up Loopback65528 192.168.1.1 YES other up up NVI0 unassigned YES unset up up Tunnel1 172.2.7.2 YES TFTP up up Tunnel2 172.3.9.7 YES TFTP up up Tunnel100001 172.4.102.1 YES other up up R2-WE1# R1-WE1#sh ip int b Interface IP-Address OK? Method Status Protocol GigabitEthernet1 172.1.8.2 YES other up up GigabitEthernet2 172.3.8.7 YES DHCP up up GigabitEthernet3 10.10.101.1 YES other up up GigabitEthernet4 unassigned YES other down down GigabitEthernet5 unassigned YES other down down GigabitEthernet6 unassigned YES other down down GigabitEthernet7 unassigned YES other down down GigabitEthernet8 192.168.150.16 YES other up up Sdwan-system-intf 1.1.100.1 YES unset up up Loopback65528 192.168.1.1 YES other up up NVI0 unassigned YES unset up up Tunnel1 172.1.8.2 YES TFTP up up Tunnel2 172.3.8.7 YES TFTP up up Tunnel100001 172.4.101.1 YES other up up R1-WE1# - Next you need to route all traffic to cloud application 16.16.16.16 to the tunnel. - Locate feature template Lab_Remote_VPN1_V01 and edit - Under IPSEC ROUTE section, add New IPSEC Route with prefix 16.16.16.16/32 interface ipsec1 Click Add to add this ipsec route. Click update to push configure change to both remote sites. Step 4.2 : verify SIG tunnel VNC login R1-VM1 and R2-VM1 with credential viptela Verify that you can ping 16.16.16.16 from the VM Now try access http://16.16.16.16 from browser. You should see this login page Task 5: DIA There are two options to enable DIA. Option 1: NAT DIA Route In this option, a NAT route is configured under service VPN. You can direct local internet traffic from service VPN to transport VPN. Option 2: Centralized data policy In this option, a centralized policy is applied to service side traffic based on ip prefixes, a match will redirect to transport VPN. Traffic that doesnt match the policy will stay in service VPN and route over IPSec tunnel. In this task, you are going to configure DIA on remote sites using option 1. Step 5.1: verify route to internet ssh into remote1_ubuntu and run traceroute 1.1.1.1 viptela@remote2_ubuntu:~$ traceroute 1.1.1.1 traceroute to 1.1.1.1 (1.1.1.1), 30 hops max, 60 byte packets 1 10.10.102.1 (10.10.102.1) 2.870 ms 2.772 ms 2.640 ms 2 172-3-6-7.lightspeed.irvnca.sbcglobal.net (172.3.6.7) 10.756 ms 172-2-3-2.lightspeed.dybhfl.sbcglobal.net (172.2.3.2) 9.857 ms 172-3-6-7.lightspeed.irvnca.sbcglobal.net (172.3.6.7) 11.087 ms 3 10.10.11.2 (10.10.11.2) 10.525 ms 11.484 ms 14.044 ms 4 * * * 5 * 198.18.128.1 (198.18.128.1) 15.788 ms * - From the traceroute you can tell host in remote1 currently route to DC for internet access Step 5.2: Enable NAT on LTE transport Login to vManage 198.18.133.200 and access template configuration from Configuration - Templates - Feature locate template Lab_Remote_VPN0_LTE_V01 and click ... to select Edit Under NAT section, change NAT checkbox to On . leave other fields as default. Click Update to push configure change. Step 5.3: Add NAT route on VPN 1 Login to vManage 198.18.133.200 and access template configuration from Configuration - Templates - Feature Locate Lab_Remote_VPN1_V01 and Edit Under IPv4 ROUTE , click New IPv4 Route enter 0.0.0.0/0 for prefix select VPN for Gateway Select On for Enable VPN Add this VPN route and update template to push configure change ssh into remote1_ubuntu and run traceroute 1.1.1.1 to verify the change viptela@remote1_ubuntu:~$ traceroute 1.1.1.1 traceroute to 1.1.1.1 (1.1.1.1), 30 hops max, 60 byte packets 1 10.10.101.1 (10.10.101.1) 2.745 ms 3.181 ms 3.098 ms 2 172-3-8-1.lightspeed.miamfl.sbcglobal.net (172.3.8.1) 3.008 ms 3.867 ms 4.379 ms 3 * * * 4 198.18.128.1 (198.18.128.1) 13.176 ms * * - From the traceroute you can see the remote site now uses local DIA for internet bound traffic. Task 6: CoR for SaaS Instead of using the DIA exit point as configured in previous task, for SaaS application box and salesforce , ACME wants to use the most optimal path. Configure the remote sites to dynamically chose local DIA or regional hub as exit point for box and salesforce based on application performance. Step 6.1 Enable Cloud OnRamp for SaaS Login to vManage 198.18.133.200 and access Administration - Settings Edit Cloud onRamp for SaaS and check Enabled Step 6.2 Add SaaS application Access CoR SaaS configuration via Configuration - Cloud onRamp for SaaS From Manage Cloud OnRamp for SaaS dropdown, select Applications and Policy Select Box and Salesforce from the application list; Select Enabled from Monitoring dropdown list; Enter 1 for VPN; Select Enabled for Policy/Cloud SLA dropdown list. Cloud OnRamp for SaaS uses existing AAR policy, we will keep the system created policy for SaaS. Click Save Policy to activate the policy update. Step 6.3 Add sites You are going to configure remote sites as DIA site, and Regional hub as gateway site. Remote sites will monitor the QoE score for local DIA via LTE transport, and also the QoE score for gateway site. Access CoR SaaS configuration via Configuration - Cloud onRamp for SaaS Click Manage Cloud OnRamp for SaaS dropdown list on the upper left, and select Gateway Click Attach Gateways , select RH-WE1 and move it to selected Sites . Click Add interfaces to selected sites . In the pop up window, select Service VPN checkbox, under Interface field select interface GigabitEthernet4 from the list, click Save Changes to finish adding Gateway site. Click Manage Cloud OnRamp for SaaS dropdown list on the upper left, and select DIA Sites Select Attach DIA Sites , select R1-WE1 and R2-WE1 and move it to selected Sites . Click Save Changes to finish adding DIA Sites. Step 6.4 Verify CoR SaaS Click Manage Cloud OnRamp for SaaS and select the Application to verify QoE status, DIA status, exit interface on each WAN Edge for SaaS application. Note: Your output may not match the screenshot on the vQoE score and DIA Status. This is expected. screenshot above shows both remote sites are using local DIA as exit point for box and Salesfoce SaaS application. This lab doesn't have traffic impairment tool, we can't increase remote transport's latency or drop to trigger SaaS changes exit point. But if you keep checking the SaaS status, you will notice the vQoE score changes and exit interface changes. Congratulation! You have completed the whole lab. Back to Top","title":"Lab 3 Tasks"},{"location":"lab3/#lab-3-performance-optimization","text":"In this section, you will help ACME to optimize their SD-WAN fabric. You will perform the following tasks in this lab. Add QoS and make sure consistent QoS policies are applied across the SD-WAN fabric. Regional hub has higher bandwidth on WAN circuits compare to remote sites. This bandwidth mismatch could potentially cause packet drops on remote sites. Configure the sd-wan fabric to prevent this potential issue. Due to the latency sensitive application requirement, a spoke to spoke tunnel is needed between remote sites. Configure the sd-wan fabric to build on-demand tunnel between remote sites. Cloud Application (16.16.16.16) requires inspection services for all users. Configure IPSec tunnel to SIG provider for inspection services and configure the sd-wan fabric to route all traffic to this application over a IPSec tunnel. ACME wants to reduce the bandwidth consumption on private WAN links. Configure the sd-wan fabric to route public cloud and Internet traffic over local internet access. For SaaS application, configure the sd-wan fabric to use either local DIA or RH based on application performance.","title":"Lab 3: Performance Optimization"},{"location":"lab3/#task-1-qos","text":"Enabling QoS has three main steps: classification, marking and queueing. Queueing policy is configured as Localized policy and applied on interface level. classification and marking can be enabled over Localized policy or over centralized data policy. ACME requires consistent QoS policies across sd-wan fabric, you will use centralized data policy to achieve that. ACME uses 4-class QoS model with the following policy requirements. Class Applications DSCP Value Queueing REALTIME Real Time Protocol,webex,zoom 46 30% SIGNALING rtcp,mgcp,sip 24 10% CRITICAL SSH,SNMP,SMB 26 40% DEFAULT 0 20%","title":"Task 1: QoS"},{"location":"lab3/#step-11-class-map-and-applications","text":"Login to vManage 198.18.133.200 and access policy configuration from Configuration - Policies Click Custom Options drop down on the top right and select Lists under Localized Policy Click Class Map list type on the left and add New Class List . In the pop up window enter REALTIME in Class filed, and select 0 from Queue dropdown. After save REALTIME class, add following three classes. Class: SIGNALING Queue: 1 Class: DEFAULT Queue: 2 Class: CRITICAL Queue: 3 Click Custom Options drop down on the top right and select Lists under Centralized Policy Click Application list type on the left and add New Application List . In the application configure window enter REAL TIME in Application List Name, and select \" RTP(Real Time Protocol) , WebEX , Zoom \" from Application drop list. After save \"REALTIME\" Application, add following two Applications Application List Name: SIGNALING Application: Real Time Control Protocol, Media Gateway Control Protocol, Session Initiation Protocol Application List Name: CRITICAL Application: Secure Shell, Simple Network Management Protocol, SMB","title":"Step 1.1: class map and applications"},{"location":"lab3/#step-12-central-data-policy-for-classification","text":"Login to vManage 198.18.133.200 and access policy configuration from Configuration - Policies Click Custom Options drop down on the top right and select Traffic Policy under Centralized Policy Select Traffic Data and select Add Policy to Create New data policy Enter Lab_QoS_v01 in Name and Description Click +Sequence Type and select QoS for new data policy type Add +Sequence Rule for following Match Conditions and Actions Application/Application Family List: REALTIME , Action Accept and Forwarding Class: REALTIME Application/Application Family List: SIGNALING , Action Accept and Forwarding Class: SIGNALING Application/Application Family List: CRITICAL , Action Accept and Forwarding Class: CRITICAL Default Match Conditions (match any): Forwarding Class: DEFAULT After Save Data Policy , go back to the Centralized Policy configuration and edit central policy LAB_Central_V02 Click Traffic Rules tab on the top then click Traffic Data and select Import Existing to add QoS data policy Lab_QoS_v01 Click Policy Application tab on the top then click Traffic Data to assign the qos data policy. To have consistent QoS policy for the fabric, We will apply the QoS policy to all sites and all VPNs on service side as show in below screenshot. Click Add and Save Policy Changes then Active the updated central policy.","title":"Step 1.2: Central Data Policy for classification"},{"location":"lab3/#step-13-local-qos-queuing-policy","text":"Login to vManage 198.18.133.200 and access policy configuration from Configuration - Policies Click Custom Options drop down on the top right and select forwarding Class/QoS under Localized Policy Select QoS Map and select Add QoS Map to create new queuing policy Lab_QoS_Map_v01 Click Add Queue to add policy for SIGNALING class as show below. Click Add Queue to add policy for CRITICAL class as show below Click Add Queue to add policy for DEFAULT class as show below The QoS queuing policy will look similar to screenshot below. After queuing policy is created, save the queueing policy. Then you will create localized policy that includes the queueing policy. Note: To save time, We will only create local policy for remote sites in this lab. Click Localized Policy tab and Add Policy Click Next move to configure Forwarding Classes/QoS Click Add QoS Map drop down and select import existing. Search Lab_QoS_Map_v01 and Import. Click next proceeding to Policy Overview. Type LAB_Remote_Local_v01 in Policy Name and Description filed. Check Netflow and Application at the bottom from Policy Settings and Save Policy","title":"Step 1.3: Local QoS queuing policy"},{"location":"lab3/#step-14-apply-qos-queuing-policy","text":"Applying QoS queuing policy is two step process, first you need to associate the localized policy to the device template, and next you need reference the queueing policy-map on transport interface. Access template configuration from Configuration - Templates Under Device template tab, locate template Lab_R1_V01 and select Edit Associate Lab_Remote_Local_V01 localized policy to the template as show below Click Update to push the new localized policy configuration. Repeat the above steps to associate policy for template Lab_R2_V01 Now you have the localized policy associated with device template for both remotes. Next you need reference the queueing policy on transport interfaces. Access template configuration from Configuration - Templates Under Feature template tab, locate template Lab_Remote_VPN0_Private1_v01 and select Edit Under ACL/QOS section, hardcode Lab_QoS_Map_v01 for QoS Map field. click update to push configuration change. Repeat the above steps to update Lab_Remote_VPN0_Private2_V01 and Lab_Remote_VPN0_LTE_V01 feature templates. After queuing policy is applied on both transport interfaces, you can verify the QoS policy from CLI using command show policy-map interface R2-WE1#show policy-map interface GigabitEthernet 2 GigabitEthernet2 Service-policy output: Lab_QoS_Map_v01 queue stats for all priority classes: Queueing priority level 1 queue limit 512 packets (queue depth/total drops/no-buffer drops) 0/0/0 (pkts output/bytes output) 22647/6060238 Class-map: Queue0 (match-any) 22647 packets, 6060238 bytes 30 second offered rate 15000 bps, drop rate 0000 bps Match: qos-group 0 police: rate 30 % rate 300000000 bps, burst 9375000 bytes conformed 22647 packets, 6060238 bytes; actions: transmit exceeded 0 packets, 0 bytes; actions: drop conformed 15000 bps, exceeded 0000 bps Priority: Strict, b/w exceed drops: 0 Priority Level: 1 Class-map: Queue1 (match-any) 0 packets, 0 bytes 30 second offered rate 0000 bps, drop rate 0000 bps Match: qos-group 1 Queueing queue limit 1041 packets (queue depth/total drops/no-buffer drops) 0/0/0 (pkts output/bytes output) 0/0 bandwidth remaining ratio 10 Class-map: Queue3 (match-any) 10268 packets, 1197729 bytes 30 second offered rate 0000 bps, drop rate 0000 bps Match: qos-group 3 Queueing queue limit 1041 packets (queue depth/total drops/no-buffer drops) 0/0/0 (pkts output/bytes output) 10268/1197729 bandwidth remaining ratio 40 Class-map: class-default (match-any) 15 packets, 1609 bytes 30 second offered rate 0000 bps, drop rate 0000 bps Match: any Queueing queue limit 1041 packets (queue depth/total drops/no-buffer drops) 0/0/0 (pkts output/bytes output) 15/1609 bandwidth remaining ratio 20 Exp-weight-constant: 9 (1/512) Mean queue depth: 0 packets class Transmitted Random drop Tail drop Minimum Maximum Mark pkts/bytes pkts/bytes pkts/bytes thresh thresh prob 0 1/349 0/0 0/0 260 520 1/10 1 0/0 0/0 0/0 292 520 1/10 2 0/0 0/0 0/0 325 520 1/10 3 0/0 0/0 0/0 357 520 1/10 4 0/0 0/0 0/0 390 520 1/10 5 0/0 0/0 0/0 422 520 1/10 6 14/1260 0/0 0/0 455 520 1/10 7 0/0 0/0 0/0 487 520 1/10","title":"Step 1.4: Apply QoS queuing policy"},{"location":"lab3/#task-2-per-tunnel-qos","text":"In this section, you will configure the RH WAN edge router ( RH-WE1 ) to shape tunnel traffic to each remote. This per-tunnel QoS will make sure RH cannot send excessive traffic to remotes and overrun it.","title":"Task 2: per-tunnel QoS"},{"location":"lab3/#step-21-configure-qos-policy-on-rh","text":"In task 1, you have configured QoS policy on remote sites. Follow the same steps to configure QoS policy on RH RH-WE1 . Login to vManage 198.18.133.200 and access policy configuration from Configuration - Policies - Localized Policy Copy policy LAB_Remote_Local_v01 and name new policy LAB_RH_Local_v01 . Access template configuration from Configuration - Templates Locate device template Lab_RH_V01 and attach localized policy LAB_RH_Local_v01 to the device template. Update following feature templates Lab_RH_VPN0_Private1_v01 Lab_RH_VPN0_Private2_V01 Lab_RH_VPN0_LTE_V01 Under ACL/QOS section, hardcode Lab_QoS_Map_v01 for QoS Map field. Note: To avoid configuration push for each feature template update, you can make a copy for each feature template, update on new feature templates, then associate the new feature templates on device template. .","title":"Step 2.1: Configure QoS policy on RH"},{"location":"lab3/#step-22-configure-hub-role-on-rh","text":"Access template configuration from Configuration - Templates Under Feature template tab, locate template Lab_RH_VPN0_Private1_v01 and select Edit Configure teh following under TUNNEL section Select On for Per-tunnel QoS to enable per-tunnel QoS Select On for Per-tunnel QoS Aggregator to set this as hub tunnel Configure Tunnel Bandwidth Percent to 80 to set maximum bandwidth usage for overlay traffic Click update to push configuration change Locate feature template Lab_RH_VPN0_Private2_V01 , and select Edit Configure teh following under TUNNEL section Select On for Per-tunnel QoS to enable per-tunnel QoS Select On for Per-tunnel QoS Aggregator to set this as hub tunnel Configure Tunnel Bandwidth Percent to 80 to set maximum bandwidth usage for overlay traffic Click update to push configuration change","title":"Step 2.2: Configure Hub role on RH"},{"location":"lab3/#step-23-configure-spoke-role-on-remotes","text":"Access template configuration from Configuration - Templates Under Feature template tab, locate template Lab_Remote_VPN0_Private1_v01 and select Edit Under TUNNEL section, configure On for Per-tunnel QoS to enable per-tunnel QoS. Since this is spoke, we will leave Per-tunnel QoS Aggregator off. To configure a device as spoke role, you will also need to configure the downstream bandwidth. In the same feature template Lab_Remote_VPN0_Private1_v01 , under BASIC CONFIGURATION section Specify the downstream bandwidth to 10Mbps for remote1 Click update to push configuration change locate template Lab_Remote_VPN0_Private2_v01 and select Edit Under TUNNEL section, configure On for Per-tunnel QoS to enable per-tunnel QoS. Since this is spoke, we will leave Per-tunnel QoS Aggregator off. To configure a device as spoke role, you will also need to configure the downstream bandwidth. In the same feature template Lab_Remote_VPN0_Private2_v01 , under BASIC CONFIGURATION section Specify the downstream bandwidth to 20Mbps for remote2 Click update to push configuration change","title":"Step 2.3: Configure Spoke role on Remotes"},{"location":"lab3/#step-24-verify-per-tunnel-qos","text":"SSH into RH-WE1 , run show platform software sdwan qos policy and show platform software sdwan qos target to verify per-tunnel QoS is working as configured. RH-WE1#show platform software sdwan qos policy ============ Session QoS Policy Database ============ policy bandwidth remaining-ratio template SDWANPolicy4210704 10000000 1 Lab_QoS_Map_v01 SDWANPolicy4210705 20000000 2 Lab_QoS_Map_v01 RH-WE1#show platform software sdwan qos target ============ Session QoS Target Database ============ src-addr dst-addr sport dport proto remote-tloc dummy-intf tunnel policy bandwidth 172.1.7.2 172.1.8.2 12346 12346 IPSEC 1.1.100.1 SDWANSession4210704 Tunnel1 SDWANPolicy4210704 10000 172.2.6.2 172.2.7.2 12346 12346 IPSEC 1.1.102.1 SDWANSession4210705 Tunnel2 SDWANPolicy4210705 20000 From the show outputs, you can find the system creates two new Hierarchical QoS Policy Maps, one for each remote site. The parent level shaper rate is equal to the downstream bandwidth you configured in previous step.","title":"Step 2.4: Verify per-tunnel QOS"},{"location":"lab3/#task-3-on-demand-tunnel","text":"Hub and Spoke topology can reduce the CPU and memory usage on WAN Edge, but sometime a spoke to spoke tunnel is needed. Dynamic on-demand tunnel offers the benefits of having direct spoke to spoke tunnel while keep the low CPU and memory usage on WAN Edge. To improve latency of traffic between remotes, configure dynamic on-demand tunnel between remote1 and remote2.","title":"Task 3: On-demand Tunnel"},{"location":"lab3/#step-31-modify-central-control-policy","text":"In Lab1 you have created hub and spoke topology for both remote sites. In order to create dynamic on-demand tunnel between remotes, first you need modify the topology policy to include a tloc-action backup action. Login to vManage 198.18.133.200 and access policy configuration from Configuration - Policies Click Custom Options drop down on the top right and select Topology under Centralized Policy Highlight topology policy LAB_Topo_RS1_V02 and select Edit Click TLOC from Sequence Type on the left Click Sequence Rule to add a new rule; configure the rule to match on site list All-Remotes , Actions Accept . Save Match And Actions to add this new rule. Click Route from Sequence Type on the left Click Sequence Rule to add a new rule; configure the rule to match on site list All-Remotes , Actions TLOC list RH_TLOCs and TLOC Action Backup . After Save Match and And Actions , drag and drop the newly created rule to seq # 1. Click Save Control Policy to push policy update Follow the same steps to modify topology policy LAB_Topo_RS2_v02 .","title":"Step 3.1: Modify central control policy"},{"location":"lab3/#step-32-configure-on-demand-tunnel","text":"Enable Traffic Engineering service on RH to allow RH as backup path. Access template configuration from Configuration - Templates Under Feature template tab, locate template Lab_RH_VPN0_v01 and select Edit Under SERVICE section, click New Service and select TE from service type drop down to add it to this feature template. Update to push configure change. On remote sites, R1-WE1 and R2-WE2, enable on-demand on system template. Under Feature template tab, locate template Lab_System_V01 and select Copy Name new system template Lab_Remote_System_V01 Edit Lab_Remote_System_V01 to enable On-demand Tunnel Locate device template Lab_R1_V01 and change system template to Lab_Remote_System_V01 Update to push configuration change. Locate device template Lab_R2_V01 and change system template to Lab_Remote_System_V01 . Update to push configuration change.","title":"Step 3.2: Configure On-demand Tunnel"},{"location":"lab3/#step-33-verify-on-demand-tunnel-between-remotes","text":"You can verify the dynamic tunnel between remotes from vManage. Login to vManage 198.18.133.200 and access Monitor - Network Select WAN-Edge R1-WE1 Click Real Time and type in on demand local in Device Options filed The output shows local on demand tunnel is enabled and status is active. Type in on demand remote in Device Options filed The output shows remote on demand tunnel to remote2 1.1.102.1 is enabled and tunnel status is inactive Dynamic on demand tunnel is triggered by traffic between the local and remote sites. That's why you see status of on demand remote is inactive. Let's generate bi-directional traffic between remote1 and remote2 to trigger on demand tunnel. ssh into R1-VM1 (the Ubuntu host), and run ssh 10.10.102.10 to login R2-VM2 with credential viptela/viptela Welcome to Ubuntu 16.04.2 LTS (GNU/Linux 4.8.0-36-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage 689 packages can be updated. 475 updates are security updates. Last login: Mon Feb 8 09:22:21 2021 from 10.16.22.163 viptela@remote1_ubuntu:~$ ssh 10.10.102.10 viptela@10.10.102.10's password: Welcome to Ubuntu 16.04.2 LTS (GNU/Linux 4.8.0-36-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage 711 packages can be updated. 521 updates are security updates. Last login: Mon Feb 8 09:25:00 2021 from 10.10.101.10 viptela@remote2_ubuntu:~$ - Go back to vManage - Monitor - Network - R1-WE1 - Real time and type in on demand remote in Device Options filed. - verify the tunnel status for on demand tunnel to remote2 1.1.102.1 changes active <img src=\"https://ciscolivelab.github.io/LTRENT-2314/img/lab3_3_3_5.PNG\" width=\"1800\"/>","title":"Step 3.3: Verify On-demand Tunnel between remotes"},{"location":"lab3/#task-4-ipsec-tunnel-to-sig","text":"Inspection service is required for traffic to cloud application with IP 16.16.16.16 . Configure remote1 and remote2 to build an IPSec tunnel to SIG provider. Route all traffic to 16.16.16.16 for inspection.","title":"Task 4: IPsec tunnel to SIG"},{"location":"lab3/#step-41-manual-ipsec-tunnel-to-sig","text":"Before configuring the IPSec tunnel, verify the connectivity to Cloud application at 16.16.16.16 from remote ubuntu hosts. It is expected to see the application is not reachable. viptela@remote1_ubuntu:~$ ping 16.16.16.16 PING 16.16.16.16 (16.16.16.16) 56(84) bytes of data. Configure IPSec tunnel on remote1 and remote2 to match the pre-configured tunnel at SIG provider. site tunnel IP tunnel source tunnel destination IKE version pre-share key Remote1 172.4.101.1/24 GigabitEthernet2 172.3.2.2 IKE v1 cisco123 Remote2 172.4.102.1/24 GigabitEthernet2 172.3.2.2 IKE v1 cisco123 Isakmp policy encryption algorithm: AES - Advanced Encryption Standard (256 bit keys). hash algorithm: Secure Hash Standard authentication method: Pre-Shared Key Diffie-Hellman group: #16 (4096 bit) lifetime: 14400 seconds, no volume limit IPSec policy Security association lifetime:3600 seconds PFS (Y/N): Y DH group: group16 Mixed-mode : Disabled Transform sets=esp-aes esp-sha-hmac Antireplay window size = 512 - Login to vManage 198.18.133.200 and access template configuration from Configuration - Templates - Feature - Add new IPsec interface feature template for CSR1000v as show below Configure the template with following fields and leave other fields as default value filed name value Template Name Lab_IPsec_Int_V01 Description Lab_IPsec_Int_V01 Shutdown No Interface Name ipsec1 IPv4 address ipsec_tun_ip source Interface IPsec Source Interface GigabitEthernet2 IPsec Destination IP Address 172.3.2.2 Preshared Key cisco123 Add tunnel feature template Lab_IPsec_Int_V01 to device template Lab_R1_V01 and Lab_R2_V01 Locate device template Lab_R1_V01 click Edit Add Lab_IPsec_Int_V01 under VPN0 Click save to update and filed in 172.4.101.1/24 for tunnel IP Address Click Update to configure device Locate device template Lab_R2_V01 click Edit Add Lab_IPsec_Int_V01 under VPN0 Click save to update and filed in 172.4.102.1/24 for tunnel IP Address Click Update to configure device The ipsec tunnel will come UP on both remote sites. You can verify the tunnel status from show ip interface brief R2-WE1#sh ip int b Interface IP-Address OK? Method Status Protocol GigabitEthernet1 172.2.7.2 YES other up up GigabitEthernet2 172.3.9.7 YES DHCP up up GigabitEthernet3 unassigned YES other down down GigabitEthernet4 10.10.102.1 YES other up up GigabitEthernet5 unassigned YES other down down GigabitEthernet6 unassigned YES other down down GigabitEthernet7 unassigned YES other down down GigabitEthernet8 192.168.150.19 YES other up up Sdwan-system-intf 1.1.102.1 YES unset up up Loopback65528 192.168.1.1 YES other up up NVI0 unassigned YES unset up up Tunnel1 172.2.7.2 YES TFTP up up Tunnel2 172.3.9.7 YES TFTP up up Tunnel100001 172.4.102.1 YES other up up R2-WE1# R1-WE1#sh ip int b Interface IP-Address OK? Method Status Protocol GigabitEthernet1 172.1.8.2 YES other up up GigabitEthernet2 172.3.8.7 YES DHCP up up GigabitEthernet3 10.10.101.1 YES other up up GigabitEthernet4 unassigned YES other down down GigabitEthernet5 unassigned YES other down down GigabitEthernet6 unassigned YES other down down GigabitEthernet7 unassigned YES other down down GigabitEthernet8 192.168.150.16 YES other up up Sdwan-system-intf 1.1.100.1 YES unset up up Loopback65528 192.168.1.1 YES other up up NVI0 unassigned YES unset up up Tunnel1 172.1.8.2 YES TFTP up up Tunnel2 172.3.8.7 YES TFTP up up Tunnel100001 172.4.101.1 YES other up up R1-WE1# - Next you need to route all traffic to cloud application 16.16.16.16 to the tunnel. - Locate feature template Lab_Remote_VPN1_V01 and edit - Under IPSEC ROUTE section, add New IPSEC Route with prefix 16.16.16.16/32 interface ipsec1 Click Add to add this ipsec route. Click update to push configure change to both remote sites.","title":"Step 4.1 : Manual IPSec tunnel to SIG"},{"location":"lab3/#step-42-verify-sig-tunnel","text":"VNC login R1-VM1 and R2-VM1 with credential viptela Verify that you can ping 16.16.16.16 from the VM Now try access http://16.16.16.16 from browser. You should see this login page","title":"Step 4.2 : verify SIG tunnel"},{"location":"lab3/#task-5-dia","text":"There are two options to enable DIA. Option 1: NAT DIA Route In this option, a NAT route is configured under service VPN. You can direct local internet traffic from service VPN to transport VPN. Option 2: Centralized data policy In this option, a centralized policy is applied to service side traffic based on ip prefixes, a match will redirect to transport VPN. Traffic that doesnt match the policy will stay in service VPN and route over IPSec tunnel. In this task, you are going to configure DIA on remote sites using option 1.","title":"Task 5: DIA"},{"location":"lab3/#step-51-verify-route-to-internet","text":"ssh into remote1_ubuntu and run traceroute 1.1.1.1 viptela@remote2_ubuntu:~$ traceroute 1.1.1.1 traceroute to 1.1.1.1 (1.1.1.1), 30 hops max, 60 byte packets 1 10.10.102.1 (10.10.102.1) 2.870 ms 2.772 ms 2.640 ms 2 172-3-6-7.lightspeed.irvnca.sbcglobal.net (172.3.6.7) 10.756 ms 172-2-3-2.lightspeed.dybhfl.sbcglobal.net (172.2.3.2) 9.857 ms 172-3-6-7.lightspeed.irvnca.sbcglobal.net (172.3.6.7) 11.087 ms 3 10.10.11.2 (10.10.11.2) 10.525 ms 11.484 ms 14.044 ms 4 * * * 5 * 198.18.128.1 (198.18.128.1) 15.788 ms * - From the traceroute you can tell host in remote1 currently route to DC for internet access","title":"Step 5.1: verify route to internet"},{"location":"lab3/#step-52-enable-nat-on-lte-transport","text":"Login to vManage 198.18.133.200 and access template configuration from Configuration - Templates - Feature locate template Lab_Remote_VPN0_LTE_V01 and click ... to select Edit Under NAT section, change NAT checkbox to On . leave other fields as default. Click Update to push configure change.","title":"Step 5.2: Enable NAT on LTE transport"},{"location":"lab3/#step-53-add-nat-route-on-vpn-1","text":"Login to vManage 198.18.133.200 and access template configuration from Configuration - Templates - Feature Locate Lab_Remote_VPN1_V01 and Edit Under IPv4 ROUTE , click New IPv4 Route enter 0.0.0.0/0 for prefix select VPN for Gateway Select On for Enable VPN Add this VPN route and update template to push configure change ssh into remote1_ubuntu and run traceroute 1.1.1.1 to verify the change viptela@remote1_ubuntu:~$ traceroute 1.1.1.1 traceroute to 1.1.1.1 (1.1.1.1), 30 hops max, 60 byte packets 1 10.10.101.1 (10.10.101.1) 2.745 ms 3.181 ms 3.098 ms 2 172-3-8-1.lightspeed.miamfl.sbcglobal.net (172.3.8.1) 3.008 ms 3.867 ms 4.379 ms 3 * * * 4 198.18.128.1 (198.18.128.1) 13.176 ms * * - From the traceroute you can see the remote site now uses local DIA for internet bound traffic.","title":"Step 5.3: Add NAT route on VPN 1"},{"location":"lab3/#task-6-cor-for-saas","text":"Instead of using the DIA exit point as configured in previous task, for SaaS application box and salesforce , ACME wants to use the most optimal path. Configure the remote sites to dynamically chose local DIA or regional hub as exit point for box and salesforce based on application performance.","title":"Task 6: CoR for SaaS"},{"location":"lab3/#step-61-enable-cloud-onramp-for-saas","text":"Login to vManage 198.18.133.200 and access Administration - Settings Edit Cloud onRamp for SaaS and check Enabled","title":"Step 6.1 Enable Cloud OnRamp for SaaS"},{"location":"lab3/#step-62-add-saas-application","text":"Access CoR SaaS configuration via Configuration - Cloud onRamp for SaaS From Manage Cloud OnRamp for SaaS dropdown, select Applications and Policy Select Box and Salesforce from the application list; Select Enabled from Monitoring dropdown list; Enter 1 for VPN; Select Enabled for Policy/Cloud SLA dropdown list. Cloud OnRamp for SaaS uses existing AAR policy, we will keep the system created policy for SaaS. Click Save Policy to activate the policy update.","title":"Step 6.2 Add SaaS application"},{"location":"lab3/#step-63-add-sites","text":"You are going to configure remote sites as DIA site, and Regional hub as gateway site. Remote sites will monitor the QoE score for local DIA via LTE transport, and also the QoE score for gateway site. Access CoR SaaS configuration via Configuration - Cloud onRamp for SaaS Click Manage Cloud OnRamp for SaaS dropdown list on the upper left, and select Gateway Click Attach Gateways , select RH-WE1 and move it to selected Sites . Click Add interfaces to selected sites . In the pop up window, select Service VPN checkbox, under Interface field select interface GigabitEthernet4 from the list, click Save Changes to finish adding Gateway site. Click Manage Cloud OnRamp for SaaS dropdown list on the upper left, and select DIA Sites Select Attach DIA Sites , select R1-WE1 and R2-WE1 and move it to selected Sites . Click Save Changes to finish adding DIA Sites.","title":"Step 6.3 Add sites"},{"location":"lab3/#step-64-verify-cor-saas","text":"Click Manage Cloud OnRamp for SaaS and select the Application to verify QoE status, DIA status, exit interface on each WAN Edge for SaaS application. Note: Your output may not match the screenshot on the vQoE score and DIA Status. This is expected. screenshot above shows both remote sites are using local DIA as exit point for box and Salesfoce SaaS application. This lab doesn't have traffic impairment tool, we can't increase remote transport's latency or drop to trigger SaaS changes exit point. But if you keep checking the SaaS status, you will notice the vQoE score changes and exit interface changes.","title":"Step 6.4 Verify CoR SaaS"},{"location":"lab3/#congratulation-you-have-completed-the-whole-lab","text":"Back to Top","title":"Congratulation! You have completed the whole lab."},{"location":"survey/","text":"Please login your survey dashboard to submit your survey and we appreciate your feedbacks! https://reg.rainfocus.com/flow/cisco/ciscolive2021/adashsurvey/page/surveydash","title":"Survey"}]}